<!DOCTYPE html><html>
  <head>
    <meta charSet="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>
      Sample Fornax blog
    </title>
    <base href="/newbienewbie/"/>
    <script>
      document.addEventListener('DOMContentLoaded', () => {

	// Get all "navbar-burger" elements
	const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  
	// Check if there are any navbar burgers
	if ($navbarBurgers.length > 0) {
  
	  // Add a click event on each of them
	  $navbarBurgers.forEach( el => {
		el.addEventListener('click', () => {
  
		  // Get the target from the "data-target" attribute
		  const target = el.dataset.target;
		  const $target = document.getElementById(target);
  
		  // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
		  el.classList.toggle('is-active');
		  $target.classList.toggle('is-active');
  
		});
	  });
	}
  });
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"/>
    <link rel="stylesheet" href="https://unpkg.com/bulma@0.8.0/css/bulma.min.css"/>
    <link rel="stylesheet" type="text/css" href="style/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/atom-one-dark-reasonable.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" href="">
            <img src="images/bulma.png" alt="Logo"/>
          </a>
          <span class="navbar-burger burger" data-target="navbarMenu">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </div>
        <div id="navbarMenu" class="navbar-menu">
          <a class="navbar-item" href="">
            Home
          </a>
          <a class="navbar-item" href="tags.html">
            Tags
          </a>
          <a class="navbar-item" href="about.html">
            About
          </a>
          <a class="navbar-item" href="contact.html">
            Contact
          </a>
        </div>
      </div>
    </nav>
    <section class="hero is-info is-medium is-bold">
      <div class="hero-body">
        <div class="container has-text-centered">
          <h1 class="title">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit
          </h1>
        </div>
      </div>
    </section>
    <div class="container">
      <section class="articles">
        <div class="column is-8 is-offset-2">
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/Boulevard/Compiler/自制编程语言/crowbar源码阅读笔记(6).html">
                    crowbar源码阅读笔记(6):语句执行
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        大道
                      </a>
                    </li>
                    <li>
                      <a href="">
                        编译原理
                      </a>
                    </li>
                    <li>
                      <a href="">
                        自制编程语言
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#编译原理">
                    <span class="tag is-info">
                      编译原理
                    </span>
                  </a>
                  <a href="/tags.html#自制编程语言">
                    <span class="tag is-info">
                      自制编程语言
                    </span>
                  </a>
                  <a href="/tags.html#crowbar">
                    <span class="tag is-info">
                      crowbar
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2017-08-20
                </p>
              </div>
              <div class="content article-body">
                <p>这是《自制编程语言》一书中的脚本语言<code>crowbar</code>的源码阅读笔记(6):语句执行。语句执行的实现代码主要存放于文件<code>execute.c</code>中。</p>
<h2>语句执行总体框架</h2>
<h3>单语句执行</h3>
<p>运行单个语句，则和表达式求值的思路一样，要区分具体的语句类型，然后执行不同的策略，最后返回语句执行结果(<code>StatementResult</code>类型对象)：</p>
<pre><code class="language-c">static StatementResult execute_statement(CRB_Interpreter *inter, LocalEnvironment *env, Statement *statement)
{
    StatementResult result;

    result.type = NORMAL_STATEMENT_RESULT;

    switch (statement-&gt;type) {
    case EXPRESSION_STATEMENT:
        result = execute_expression_statement(inter, env, statement);
        break;
    case GLOBAL_STATEMENT:
        result = execute_global_statement(inter, env, statement);
        break;
    case IF_STATEMENT:
        result = execute_if_statement(inter, env, statement);
        break;
    case WHILE_STATEMENT:
        result = execute_while_statement(inter, env, statement);
        break;
    case FOR_STATEMENT:
        result = execute_for_statement(inter, env, statement);
        break;
    case RETURN_STATEMENT:
        result = execute_return_statement(inter, env, statement);
        break;
    case BREAK_STATEMENT:
        result = execute_break_statement(inter, env, statement);
        break;
    case CONTINUE_STATEMENT:
        result = execute_continue_statement(inter, env, statement);
        break;
    case STATEMENT_TYPE_COUNT_PLUS_1:   /* FALLTHRU */
    default:
        DBG_panic((&quot;bad case...%d&quot;, statement-&gt;type));
    }

    return result;
}
</code></pre>
<!-- more -->
<p>不同语句有不同的执行结果，语句执行结果抽象为一个结构体</p>
<pre><code class="language-c">typedef struct {
    StatementResultType type;
    union {
        CRB_Value       return_value;
    } u;
} StatementResult;
</code></pre>
<p>语句的执行结果有不同类型，可以分为:</p>
<ul>
<li><code>NORMAL_STATEMENT_RESULT</code>：常规语句执行</li>
<li><code>RETURN_STATEMENT_RESULT</code>: 返回语句执行</li>
<li><code>BREAK_STATEMENT_RESULT</code> : <code>break</code>语句执行</li>
<li><code>CONTINUE_STATEMENT_RESULT</code>: <code>continue</code>语句执行</li>
<li><code>STATEMENT_RESULT_TYPE_COUNT_PLUS_1</code>:</li>
</ul>
<p>其中，<code>RETURN_STATEMENT_RESULT</code>、<code>BREAK_STATEMENT_RESULT</code>标识了将要中断循环；而<code>CONTINUE_STATEMENT_RESULT</code>则表示要循环体语句的执行<code>crb_execute_statement_list()</code>将要被中断。</p>
<p>语句执行后的结果值用联合<code>u</code>表示，目前只有个表示返回值的<code>return_value</code>字段，这是一个<code>CRB_Value</code>型结构，可以统一表达各种类型的返回值。</p>
<h3>语句链表的执行</h3>
<p>语句链表的执行，是依次执行语句并检查执行结果：</p>
<pre><code class="language-c">StatementResult crb_execute_statement_list(CRB_Interpreter *inter, LocalEnvironment *env, StatementList *list)
{
    StatementList *pos;
    StatementResult result;

    result.type = NORMAL_STATEMENT_RESULT;
    for (pos = list; pos; pos = pos-&gt;next) {
        result = execute_statement(inter, env, pos-&gt;statement);
        if (result.type != NORMAL_STATEMENT_RESULT)
            goto FUNC_END;
    }

  FUNC_END:
    return result;
}
</code></pre>
<h2>表达式语句</h2>
<p>表达式类型的语句执行非常简单，就是对相应的表达式进行求值：</p>
<pre><code class="language-c">static StatementResult execute_expression_statement(CRB_Interpreter *inter, LocalEnvironment *env, Statement *statement)
{
    StatementResult result;
    CRB_Value v;

    result.type = NORMAL_STATEMENT_RESULT;

    v = crb_eval_expression(inter, env, statement-&gt;u.expression_s);
    if (v.type == CRB_STRING_VALUE) {
        crb_release_string(v.u.string_value);
    }

    return result;
}
</code></pre>
<p>表达式语句不设置语句返回值，只是填充<code>type</code>为<code>NORMAL_STATEMENT_RESULT</code>。比如：</p>
<pre><code class="language-js">v1=3+4*2;
</code></pre>
<p>这是一个 <strong>赋值表达式</strong> 构成的语句。赋值表达式求值会计算等号右边的值，然后赋给<code>v1</code>标识符对应的变量。最后当这个语句执行完毕后返回一个执行结果。
注意，该语句结果并不包含表达式的值，只告诉解释器，该语句执行完毕后是一个<code>NORMAL_STATEMENT_RESULT</code>。</p>
<h2>与关键字相关的语句</h2>
<h3><code>return</code> 语句执行</h3>
<p><code>return</code>语句的执行本身比较简单，最后也是返回一个语句执行结果，该结果的<code>type</code>字段为<code>RETURN_STATEMENT_RESULT</code>，而具体的执行值在<code>u.return_value</code>字段中填充：</p>
<ul>
<li>如果后面跟着一个表达式，则对表达式进行求值，然后填充至结果的<code>u.return_value</code>字段。</li>
<li>否则，设置<code>u.return_value.type</code>为<code>CRB_NULL_VALUE</code>。</li>
</ul>
<pre><code class="language-c">static StatementResult execute_return_statement(CRB_Interpreter *inter, LocalEnvironment *env, Statement *statement)
{
    StatementResult result;
    result.type = RETURN_STATEMENT_RESULT;

    if (statement-&gt;u.return_s.return_value) {
        result.u.return_value = crb_eval_expression(inter, env, statement-&gt;u.return_s.return_value);
    } else {
        result.u.return_value.type = CRB_NULL_VALUE;
    }

    return result;
}
</code></pre>
<h3><code>for</code> 循环语句执行</h3>
<p>一个完整的<code>for</code>语句可以拆分4个部分，即<code>init</code>、<code>condition</code>、 <code>post</code>、<code>block</code> ：</p>
<pre><code class="language-c">for(init;condition;post)
    block
</code></pre>
<p>具体执行过程是：</p>
<ol>
<li>先对<code>init</code>部分的表达式进行求值，</li>
<li>然后检测是否达到终止条件，</li>
<li>如果未达到，则执行<code>for</code>语句块。</li>
<li>如果执行结果满足<code>return</code>、<code>break</code>这类跳出条件的，则终止循环。</li>
<li>如果需要继续，则执行<code>post</code>相关表达式</li>
<li>最后开始下一次循环。</li>
</ol>
<pre><code class="language-c">static StatementResult execute_for_statement(CRB_Interpreter *inter, LocalEnvironment *env, Statement *statement)
{
    StatementResult result;
    CRB_Value   cond;

    result.type = NORMAL_STATEMENT_RESULT;

    /* 对for循环的init表达式求值 */
    if (statement-&gt;u.for_s.init) {
        crb_eval_expression(inter, env, statement-&gt;u.for_s.init);
    }
    for (;;) {
        /* 检测是否满足for循环的condition */
        if (statement-&gt;u.for_s.condition) {
            cond = crb_eval_expression(inter, env, statement-&gt;u.for_s.condition);
            if (cond.type != CRB_BOOLEAN_VALUE) {
                crb_runtime_error(statement-&gt;u.for_s.condition-&gt;line_number, NOT_BOOLEAN_TYPE_ERR, MESSAGE_ARGUMENT_END);
            }
            DBG_assert(cond.type == CRB_BOOLEAN_VALUE, (&quot;cond.type..%d&quot;, cond.type));
            if (!cond.u.boolean_value)
                break;
        }
        /* 执行for循环的循环体block */
        result = crb_execute_statement_list(inter, env, statement-&gt;u.for_s.block -&gt;statement_list);

        /* 检测是否需要返回 */
        if (result.type == RETURN_STATEMENT_RESULT) {
            break;
        }
        /* 检测是否需要中断循环 */
        else if (result.type == BREAK_STATEMENT_RESULT) {
            result.type = NORMAL_STATEMENT_RESULT;
            break;
        }

        /* 对for循环的post表达式求值 */
        if (statement-&gt;u.for_s.post) {
            crb_eval_expression(inter, env, statement-&gt;u.for_s.post);
        }
    }

    return result;
}
</code></pre>
<h2>其他语句</h2>
<p>其他语句与上述语句类似，不再赘述。</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.js"></script>
    <script>
       // 处理形如 <code>$E=mc^2$</code> 形式的公式
 var inlineMathNodes=document.querySelectorAll('code');
 var re=/^\$(.*)\$$/;
 for(var j=0;j<inlineMathNodes.length;j++){
   var result=re.exec(inlineMathNodes.item(j).innerText);
   if(result!==null){
	 katex.render(result[1], inlineMathNodes.item(j));
   }
 }
 function removeNode(node){
   if(node.remove){
	 node.remove();
   }else{
	 return first.parentNode.removeChild(node);
   }
 };

 // 查找所有 pre code.language-math 节点 以备筛出数据公式
 var nodes=document.querySelectorAll("pre code.language-math");
 for(var i=0;i<nodes.length;i++){
   var node=nodes.item(i);
   // 魔术标记所在行 
   try{
	 var lines = node.innerText.split('\n');
	 if((!!lines) && lines.length > 0)
	 {
	   var first = lines[0];
	   if(first.trim().match(/%%(\s?)*KaTeX(\s?)*/i)){
		 var views = "";
		 // 逐行渲染
		 for(var k=1; k <lines.length; k++){
			 var f=lines[k];
			 views += katex.renderToString(f);
		 }
		 // 消除父级嵌套 
		 try{
		   node.innerHTML=views;
		 }catch(e){
		   // IE9 don't support the method of assignning value to tr.innerHTML. Maybe the code below will be removed in the future
		   console.log('IE9 sucks',e);
		   $(tr).html(node.innerHTML);
		 }
	   }
	 }
   }
   catch(err){
	 console.log(err)
   }
 }
    </script>
    <script>
      hljs.highlightAll();
    </script>
  </body>
</html>