<!DOCTYPE html><html>
  <head>
    <meta charSet="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>
      Sample Fornax blog
    </title>
    <base href="/newbienewbie/"/>
    <script>
      document.addEventListener('DOMContentLoaded', () => {

	// Get all "navbar-burger" elements
	const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  
	// Check if there are any navbar burgers
	if ($navbarBurgers.length > 0) {
  
	  // Add a click event on each of them
	  $navbarBurgers.forEach( el => {
		el.addEventListener('click', () => {
  
		  // Get the target from the "data-target" attribute
		  const target = el.dataset.target;
		  const $target = document.getElementById(target);
  
		  // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
		  el.classList.toggle('is-active');
		  $target.classList.toggle('is-active');
  
		});
	  });
	}
  });
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"/>
    <link rel="stylesheet" href="https://unpkg.com/bulma@0.8.0/css/bulma.min.css"/>
    <link rel="stylesheet" type="text/css" href="style/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/atom-one-dark-reasonable.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" href="">
            <img src="images/bulma.png" alt="Logo"/>
          </a>
          <span class="navbar-burger burger" data-target="navbarMenu">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </div>
        <div id="navbarMenu" class="navbar-menu">
          <a class="navbar-item is-active" href="">
            Home
          </a>
          <a class="navbar-item" href="tags.html">
            Tags
          </a>
          <a class="navbar-item" href="about.html">
            About
          </a>
          <a class="navbar-item" href="contact.html">
            Contact
          </a>
        </div>
      </div>
    </nav>
    <section class="hero is-info is-medium is-bold">
      <div class="hero-body">
        <div class="container has-text-centered">
          <h1 class="title">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit
          </h1>
        </div>
      </div>
    </section>
    <div class="container">
      <section class="articles">
        <div class="column is-8 is-offset-2">
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/architecture/Hook-and-Pluggable.html">
                    WordPress钩子和Pluggable
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <p>钩子和Pluggable是WordPress插件机制的基础。</p>
<h2>Action和Filter</h2>
<p>与Symfony/EventDispather组件、GuzzleHttp 的事件分发机制类似，WordPress提供了一种过程式的钩子实现。当特定事件发生时，WordPress就会根据当前事件对所关联的函数进行调用。</p>
<p>布置钩子的常用函数：</p>
<ul>
<li><code>do_action</code></li>
<li><code>do_action_ref_array</code></li>
<li><code>apply_filters</code></li>
<li><code>apply_filters_ref_array</code></li>
</ul>
<p>类似这些钩子，可以接受不定数量的参数 ，如：</p>
<pre><code class="language-PHP">do_action('save_post',$post_id,$post);

do_action( $hook_name, $arg_1, $arg_2, $arg_3,... );
</code></pre>
<p>因此，在将函数钩到事件时，需要用第四个参数来说明钩取的函数接受的参数数量:</p>
<pre><code class="language-PHP">add_action ( 'hook_name', 'your_function_name', [priority], [accepted_args_num=1] );
add_filter ( 'hook_name', 'your_function_name', [priority], [accepted_args_num=1] );
</code></pre>
<p>还可以将事件对应的函数移除：</p>
<pre><code class="language-PHP">remove_action('action_hook_name','action_function_name');
remove_filter('filter_hook_name','filter_function_name');
</code></pre>
<h2>Pluggable 函数</h2>
<p>除了钩子（actions 和 filters）,另外一个修改WordPress行为的方法是覆盖Pluggable的函数。</p>
<p>在<code>wp-includes/pluggable.php</code>文件中，预定义了一小部分函数。此文件会在加载完插件后加载:</p>
<pre><code class="language-PHP">// wp-settings.php

//...

register_theme_directory( get_theme_root() ); // Register the default theme directory root

// Load active plugins.
foreach ( wp_get_active_and_valid_plugins() as $plugin ) {
	wp_register_plugin_realpath( $plugin );
	include_once( $plugin );
}
unset( $plugin );

// Load pluggable functions.
require( ABSPATH . WPINC . '/pluggable.php' );
require( ABSPATH . WPINC . '/pluggable-deprecated.php' );

//...

</code></pre>
<p>此<code>pluggable.php</code>文件中定义的函数，都采用类似以下的形式，以保证只有当所有的插件都被加载后仍未定义的函数，这部分预定义的函数才会被定义。</p>
<pre><code class="language-PHP">// wp-includes/pluggable.php

if ( !function_exists('wp_get_current_user') ) :
    function wp_get_current_user() {
        global $current_user;
        get_currentuserinfo();
        return $current_user;
    }
endif;

</code></pre>
<p>尽管如此，Pluggable functions are no longer being added to WordPress core. All new functions instead use filters on their output to allow for similar overriding of their functionality.</p>

              </div>
            </div>
          </div>
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/architecture/architecture3-template.html">
                    WordPress 前台基础架构分析之三：模板
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <h2>加载模板</h2>
<p>WP的模板加载是通过wp-includes/template-load.php文件来完成的：</p>
<pre><code class="language-PHP">&lt;?
//wp-includes/template-loader.php
//...

if ( defined('WP_USE_THEMES') &amp;&amp; WP_USE_THEMES ) :
	$template = false;
	if     ( is_404()            &amp;&amp; $template = get_404_template()            ) :
	elseif ( is_search()         &amp;&amp; $template = get_search_template()         ) :
	elseif ( is_front_page()     &amp;&amp; $template = get_front_page_template()     ) :
	elseif ( is_home()           &amp;&amp; $template = get_home_template()           ) :
	elseif ( is_post_type_archive() &amp;&amp; $template = get_post_type_archive_template() ) :
	elseif ( is_tax()            &amp;&amp; $template = get_taxonomy_template()       ) :
	elseif ( is_attachment()     &amp;&amp; $template = get_attachment_template()     ) :
		remove_filter('the_content', 'prepend_attachment');
	elseif ( is_single()         &amp;&amp; $template = get_single_template()         ) :
	elseif ( is_page()           &amp;&amp; $template = get_page_template()           ) :
	elseif ( is_category()       &amp;&amp; $template = get_category_template()       ) :
	elseif ( is_tag()            &amp;&amp; $template = get_tag_template()            ) :
	elseif ( is_author()         &amp;&amp; $template = get_author_template()         ) :
	elseif ( is_date()           &amp;&amp; $template = get_date_template()           ) :
	elseif ( is_archive()        &amp;&amp; $template = get_archive_template()        ) :
	elseif ( is_comments_popup() &amp;&amp; $template = get_comments_popup_template() ) :
	elseif ( is_paged()          &amp;&amp; $template = get_paged_template()          ) :
	else :
		$template = get_index_template();
	endif;
	/**
	 * Filter the path of the current template before including it.
	 *
	 * @since 3.0.0
	 *
	 * @param string $template The path of the template to include.
	 */
	if ( $template = apply_filters( 'template_include', $template ) )
		include( $template );
	return;
endif;

</code></pre>
<p>显然，WordPress是根据请求标志<code>is_xxx()</code>(由<code>WP_Query</code>全局类对象设置)来判定要加载哪个模板的。</p>
<p>这里出现的<code>get_xxx_template()</code>函数都在<code>wp-includes/template.php</code>中定义,内部是通过调用<code>get_query_template()</code>实现的。例如,
获取<code>index.php</code>:</p>
<pre><code class="language-PHP">function get_index_template() {
	return get_query_template('index');
}
</code></pre>
<p>和获取<code>404.php</code></p>
<pre><code class="language-PHP">function get_404_template() {
	return get_query_template('404');
}
</code></pre>
<p><code>get_query_template()</code>非常简单,核心功能就是</p>
<ol>
<li>利用<code>locate_template()</code>找出优先级别最高的模板的位置：</li>
<li>部署钩子</li>
</ol>
<p>当模板等级中最优先的模板被找到后，WordPress会对其进行加载并生成响应。</p>
<p>一个来自于WordPress官方的例子：</p>
<p>如果你的博客位于<code>http://example.com/blog/</code> ，有一个访问者点击了这样一个分类页<code> http://example.com/blog/category/your-cat/</code>， WordPress会在当前模板主题目录中以这样的过程搜寻模板:</p>
<ol>
<li>先试图搜寻文件名匹配category’s slug的模板文件. 例如当category slug是“unicorns”的时候，那么WordPress会搜寻名为<code>category-unicorns.php</code>的文件</li>
<li>如果<code>category-unicorns.php</code>找不见，并且category id是4, WordPress会继续搜寻名为<code>category-4.php</code>的文件</li>
<li>如果<code>category-4.php</code>仍然找不见, WordPress则会搜寻通用的category template<code>category.php</code></li>
<li>如果<code>category.php</code>也不存在, WordPress会搜寻通用的archive template, <code>archive.php</code></li>
<li>如果<code>archive.php</code>仍然找不到, WordPress则会退回去搜寻主题主页<code>index.php</code></li>
</ol>
<h3>模板类型</h3>
<p>WordPress常见的模板类型及代表性的模板包括：</p>
<ul>
<li>Archive Page                   #archive.php
<ul>
<li>Author Archive             #author.php</li>
<li>Category Archive           #category.php</li>
<li>Tag Archive                #tag.php</li>
<li>Custom Taxonomy Archive    #taxonomy.php</li>
<li>Date Archive               #date.php</li>
<li>Custom Post Type Archive   #archive-$posttype.php</li>
</ul>
</li>
<li>Singular Page                  #singular.php
<ul>
<li>Single Post                #single.php
<ul>
<li>Attachment Page        #attachment.php</li>
<li>Blog Post              #single-post.php</li>
<li>Custom Post            #single-{$posttype}.php</li>
</ul>
</li>
<li>Static Page                #page.php</li>
</ul>
</li>
<li>Site Front Page                #front-page.php</li>
<li>Blog Posts Index Page          #home.php</li>
<li>Comments Popup Page            #comments-popup.php</li>
<li>Error 404 Page                 #404.php</li>
<li>Search Result Page             #search.php</li>
</ul>
<p>特别的，对于某种Post Type(包括post类型)，其归档页模板的寻找路线是：</p>
<ol>
<li>archive-{$posttype}.php</li>
<li>archive.php</li>
<li>index.php</li>
</ol>
<p>其单页面模板的寻找路线是：</p>
<ol>
<li>single-{$posttype}.php</li>
<li>single.php</li>
<li>singular.php</li>
<li>index.php</li>
</ol>
<p>在WordPress中，任意一个最终没有找到对应的模板文件的请求都会被<code>index.php</code>模板处理。</p>
<h3>Template Hierarchy与钩子</h3>
<h4>模板重定向</h4>
<p>在文件<code>wp-includes/template-loader.php</code>的开头，WordPress布置了一个重定向action钩子：</p>
<pre><code class="language-PHP">// wp-includes/template-loader.php

if ( defined('WP_USE_THEMES') &amp;&amp; WP_USE_THEMES ) 
    do_action( 'template_redirect' );
//...

// 查找要加载哪个模板
// ...

</code></pre>
<p>这个钩子给了我们彻底抛弃使用WordPress默认模板等级的权利，只需要添加钩子使用自己的模板选择逻辑，然后exit就行。</p>
<h4>模板等级中的钩子</h4>
<p>WordPress模板系统能让你对默认的Template Hierarchy进行filter,这意味着我们能在等级中的某一个点进行插入和改变一些东西。</p>
<p>相关的filter钩子布置于函数<code>get_query_template()</code>中，filter钩子名的形式为<code>{$type}_template</code>:</p>
<pre><code class="language-PHP">/**
 * Retrieve path to a template
 *
 * @param string $type Filename without extension.
 * @param array $templates An optional list of template candidates
 * @return string Full path to template file.
 */
function get_query_template( $type, $templates = array() ) {
	$type = preg_replace( '|[^a-z0-9-]+|', '', $type );

	if ( empty( $templates ) )
		$templates = array(&quot;{$type}.php&quot;);

	$template = locate_template( $templates );
	/**
	 * Filter the path of the queried template by type.
	 *
	 * The dynamic portion of the hook name, `$type`, refers to the filename
	 * -- minus the extension -- of the file to load. This hook also applies
	 * to various types of files loaded as part of the Template Hierarchy.
	 *
	 * @since 1.5.0
	 *
	 * @param string $template Path to the template. See {@see locate_template()}.
	 */
	return apply_filters( &quot;{$type}_template&quot;, $template );
}
</code></pre>
<p>WordPress在按照默认的模板等级查找到相关模板后，又触发了与该模板类型相关的钩子事件，这就给了我们一个改变默认模板优先级的机会。</p>
<p>完整的filter清单如下：</p>
<ul>
<li><code>index_template</code></li>
<li><code>404_template</code></li>
<li><code>archive_template</code></li>
<li><code>author_template</code></li>
<li><code>category_template</code></li>
<li><code>tag_template</code></li>
<li><code>taxonomy_template</code></li>
<li><code>date_template</code></li>
<li><code>home_template</code></li>
<li><code>front_page_template</code></li>
<li><code>page_template</code></li>
<li><code>paged_template</code></li>
<li><code>search_template</code></li>
<li><code>single_template</code></li>
<li><code>text_template</code>,<code>plain_template</code>,<code>text_plain_template</code>,</li>
<li><code>attach_template</code></li>
<li><code>comments_template</code></li>
</ul>
<p>当需要对默认的Template Hierarchy进行修改的时候，就可以使用这些过滤器。
比如，想对默认的评论模板进行替换，就可以将自己的模板函数查找器添加filter钩子<code>comments_template</code>。
又比如，相对默认的某种PostType类型的单页模板进行修改，就可以将自己的模板函数查找器添加倒filter钩子<code>single_template</code>。</p>
<p>来自WordPress官方例子如下：</p>
<p>对于默认的Author Hierarchy：</p>
<ol>
<li><code>author-{nicename}.php</code></li>
<li><code>author-{id}.php</code></li>
<li><code>author.php</code></li>
</ol>
<p>为了在<code>author.php</code>之前增加一个被优先使用的模板<code>author-{role}.php</code></p>
<pre><code class="language-PHP">function author_role_template( $templates='' ) {
 
    $author = get_queried_object();
    $role=$author-&gt;roles[0];
 
    if(!is_array($templates) &amp;&amp; !empty($templates)) {
        $templates=locate_template(array(&quot;author-$role.php&quot;,$templates),false);
    }elseif(empty($templates)) {
        $templates=locate_template(&quot;author-$role.php&quot;,false);
    }else {
        $new_template=locate_template(array(&quot;author-$role.php&quot;));
        if(!empty($new_template)) array_unshift($templates,$new_template);
    }
    return $templates;
}
 
add_filter( 'author_template', 'author_role_template' );
</code></pre>
<h4>模板加载前的filter钩子</h4>
<p>最后，在模板找到之后和加载之前的时刻，WordPress还布置了一个名为<code>template_include</code>的钩子：</p>
<pre><code class="language-PHP">// wp-includes/template-loader.php

if ( $template = apply_filters( 'template_include', $template ) )
    include( $template );
return;
</code></pre>
<p>此filter钩子可以帮助我们加载最终合适的模板。对于Custom Post Type的各类模板加载非常有用。</p>
<p>例如，著名插件Woocommerce中，为了保证插件对所有模板适用，把相关的自定义模板都放到了自己插件的子目录下，同时添加钩子函数引入自己的模板加载器：</p>
<pre><code class="language-PHP">
class WC_Template_Loader {

    //...

    public static function init() {
        add_filter( 'template_include', array( __CLASS__, 'template_loader' ) );
        add_filter( 'comments_template', array( __CLASS__, 'comments_template_loader' ) );
    }


	public static function template_loader( $template ) {
        //...
		return $template;
	}



	public static function comments_template_loader( $template ) {
        //...
		return $template;
	}

    //...

}

</code></pre>
<p>这是一种十分健壮的做法。</p>
<h2>总结</h2>
<p>WordPress的前台博客功能其实思路非常简单，即</p>
<ol>
<li>加载必要文件</li>
<li>执行查询并设置全局变量</li>
<li>加载相关模板</li>
</ol>
<p>加载相关模板特别需要理解的是$post-type的归档页和单页的模板加载优先级。</p>

              </div>
            </div>
          </div>
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/wordpress-plugin-dev/i18n.html">
                    WordPress i18n
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <p>I18n是 <code>internationalization</code>的缩写, 表示的是对一个application的翻译过程。之所以叫&quot;i18n&quot; ，那是因为此单词的首字母<code>i</code>和尾字母<code>n</code>之间还有18个字母。</p>
<h2>名词解释</h2>
<ol>
<li>Internationalization : is the process of setting up software so that it can be localized;</li>
<li>localization: is the process of translating text displayed by the software into different languages.</li>
</ol>
<h2>插件的翻译</h2>
<h3>资源文件的加载</h3>
<p>WordPress 使用<code>gettext</code>库来完成i18n工作，</p>
<p>插件的翻译文件并不会被自动加载，我们需要手工添加相关代码。</p>
<p>添加以下代码来确保language files会被加载：</p>
<pre><code class="language-PHP">load_plugin_textdomain( $domain, $path_from_abspath, $path_from_plugins_folder );
</code></pre>
<p>这里$domain的命名有严格的约定：</p>
<pre><code class="language-PHP">function myplugin_init() {
    $plugin_dir = basename(dirname(__FILE__));
    load_plugin_textdomain( 'my-plugin', false, $plugin_dir );
}
add_action('plugins_loaded', 'myplugin_init');
</code></pre>
<p>这个调用会试图从你的插件的base directory下加载名为<code>my-plugin-{locale}.mo</code>的文件。这里<code>locale</code>是指在<code>wp-config.php</code>中定义的<code>WPLANG</code>。</p>
<h3>根据资源文件进行翻译</h3>
<p>获取翻译后字符串：</p>
<pre><code class="language-PHP">__('String name','my-text-domain'); 
</code></pre>
<p>输出翻译后的字符串：</p>
<pre><code class="language-PHP">_e('String name','my-text-domain'); 
</code></pre>
<p>翻译过程会在你插件的<code>/languages</code>下查找相应文件。</p>
<h3>复数</h3>
<p>许多语言都有复数问题。WordPress提供了<code>_n()</code>函数来解决这个问题：</p>
<pre><code class="language-PHP">printf( 
    _n( 
        'We deleted %d spam message.', 
        'We deleted %d spam messages.', 
        $count, 
        'my-text-domain' 
    ), 
    $count 
);
</code></pre>
<p>函数<code>_n()</code>接受四个参数：</p>
<ol>
<li>singualr</li>
<li>plural</li>
<li>count</li>
<li>domain</li>
</ol>
<h3>语境切换</h3>
<p>一词多义的情况在自然语言中是比较常见的情况。WordPress提供了<code>_x()</code>和<code>_ex()</code>来根据语境切换合适的翻译。</p>
<p>类似于<code>__()</code>的<code>_x()</code>:</p>
<pre><code class="language-PHP">echo _x( 'string ', 'the-context', 'my-text-domain' );
</code></pre>
<p>类似于<code>_e()</code>的<code>_ex()</code>:</p>
<pre><code class="language-PHP">_ex( 'string ', 'the-context', 'my-text-domain' );
</code></pre>
<h3>处理JavaScript</h3>
<p>使用函数<code>wp_localize_script()</code> ：</p>
<pre><code class="language-PHP">wp_enqueue_script( 'script-handle', … );
wp_localize_script( 'script-handle', 'objectL10n', array(
	'speed'  =&gt; $distance / $time,
	'submit' =&gt; __( 'Submit', 'my-text-domain' ),
) );
</code></pre>
<p>然后在JavaScript文件中，就可以使用相应的<code>objectL10n</code></p>
<pre><code class="language-JavaScript">$('#submit').val(objectL10n.submit);
$('#speed').val('{speed} km/h'.replace('{speed}', objectL10n.speed));
</code></pre>
<h2>最佳实践</h2>
<ul>
<li>Decent English: style—minimize slang and abbreviations.</li>
<li>Entire sentences: in most languages word order is different than that in English.</li>
<li>Split at paragraphs: merge related sentences, but do not include a whole page of text in one string.</li>
<li>Avoid unusual markup and unusual control characters: do not include tags that surround your text and do not leave URLs for translation, unless they could have a version in another language.</li>
<li>Do not leave leading or trailing whitespace in a translatable phrase.</li>
</ul>
<p>当翻译一个组件的时候，还需要：</p>
<ul>
<li>you must use a domain, which is loaded in a hook of your plugin</li>
<li>every translation call must become <code>__('Text', 'my-text-domain')</code></li>
<li>your domain name, which probably will resemble or be the same as your plugin name, must include no underscores.</li>
</ul>

              </div>
            </div>
          </div>
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/wordpress-plugin-dev/Widget.html">
                    WordPress Widget
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <h2>Widget</h2>
<p>WordPress2.8之后提供了<code>WP_Widget</code>类(位于文件<code>wp-includes/widgets.php</code>中)，用以简化小部件的管理。</p>
<pre><code class="language-PHP">
class WP_Widget extends WP_Widget{

	public function __construct( $id_base, $name, $widget_options = array(), $control_options = array() ) {

    }

    function form($instance) {
        // widget form in admin dashboard
    }

    function update($new_instance, $old_instance) {
        // save widget options
    }

    function widget($args, $instance) {
        // display the widget
    }
}

</code></pre>
<h2>Widget的实例化</h2>
<p>Widget的注册是通过函数</p>
<pre><code class="language-PHP">register_widget('MyWidgetClassName');
</code></pre>
<p>此函数实际只是简单利用调用全局对象<code>$wp_widget_factory</code>来进行的;</p>
<pre><code class="language-PHP">// wp-includes/widgets.php

function register_widget($widget_class) {
	global $wp_widget_factory;

	$wp_widget_factory-&gt;register($widget_class);
}
</code></pre>
<p><code>WP_Widget_Factory</code>类是一个非常简单的类，内部维护了已注册的widegets数组。</p>
<pre><code class="language-PHP">// wp-includes/widgets.php

class WP_Widget_Factory {

	public $widgets = array();

    //...

    public function register( $widget_class ) {
        $this-&gt;widgets[$widget_class] = new $widget_class();
    }

	public function unregister( $widget_class ) {
		unset( $this-&gt;widgets[ $widget_class ] );
	}

    //...
}
</code></pre>
<h2>钩子</h2>
<p>可以通过WordPress的<code>widget_init</code>事件布置widget的注册代码。</p>
<pre><code class="language-PHP">add_action('widget_init',function(){
    register_widget('MyWidgetClassName');
})
</code></pre>

              </div>
            </div>
          </div>
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/wordpress-plugin-dev/Custom-Post-Type.html">
                    WordPress Custom Post Type
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <p>WordPress自带了5种Post Type：</p>
<ol>
<li>Post</li>
<li>Page</li>
<li>Attachment</li>
<li>Revision</li>
<li>Nav Menus</li>
</ol>
<p>对于一个基本的博客，这些类型足以应付大多数需求。但是当情况复杂后，就需要定制自己的Post Type了。</p>
<h2>Custom Post Type</h2>
<p>定制的Post Type可能是任何东西，不仅仅是面向公众的内容碎片。比如，可以定制自己的Post Type来跟踪程序中错误。</p>
<p>WordPress提供的Custom Post Type功能使得WP的Post足以模拟任何实体——“The only limitation is your imagination”。</p>
<h3>注册定制的Post Type</h3>
<p>注册新的Post Type类型可以用以下函数实现：</p>
<pre><code class="language-PHP">
register_post_type($post_type,$args_array);
</code></pre>
<p>一般都在<code>init</code>时进行注册：</p>
<pre><code class="language-PHP">add_action('init',function(){
    register_post_type(
        'mytesttype',
        array(
            'labels' =&gt; array( 'name' =&gt; 'MyTester' ), 
            'public' =&gt; true, 
        )
    );
});

</code></pre>
<h3>定制Post Type参数</h3>
<p>函数<code>register_post_type()</code>的第二个参数提供了众多定制Post Type的选项：</p>
<ul>
<li><code>public</code>    # 前台是否公众可见?默认为false</li>
<li><code>show_ui</code>   # 是否创建默认UI?默认为<code>public</code>定义的值</li>
<li><code>publicy_queryable</code>    # 前台公共可查？默认为<code>public</code>定义的值</li>
<li><code>exclude_from_search</code>  # 从搜索结果中排除?默认为<code>public</code>定义的值</li>
<li><code>show_in_nav_menus</code>    # nav menu可见?默认为<code>public</code>定义的值</li>
<li><code>supports</code>  # 哪些meta boxes?
<ul>
<li><code>title</code></li>
<li><code>editor</code></li>
<li><code>author</code></li>
<li><code>thumbnail</code></li>
<li><code>excerpt</code></li>
<li><code>comments</code></li>
<li><code>trackbacks</code></li>
<li><code>custom-fields</code></li>
<li><code>page-attributes</code></li>
<li><code>revision</code></li>
<li><code>post-formats</code></li>
</ul>
</li>
<li><code>labels</code>         # array，用于各种情况下显示的标签</li>
<li><code>hierarchial</code>    # 默认为false</li>
<li><code>has_archive</code></li>
<li><code>can_export</code>     # 可导出？默认为true</li>
<li><code>taxonomies</code>     # array</li>
<li><code>menu_position</code>  # 默认在评论菜单之后</li>
<li><code>menu_icon</code>      # 图标</li>
<li><code>show_in_menu</code>   # 是否在admin menu中显示</li>
<li><code>show_in_admin_bar</code>   # 是否在admin bar中显示</li>
<li><code>capability_type</code>     #</li>
<li><code>capability</code>          # an array of custom capabilities ( 改、删、阅、发布)</li>
<li><code>query_var</code>           # 查询变量</li>
<li><code>rewrite</code>             # 创建permalink</li>
</ul>
<p>其中，<code>labels</code> 接受一个数组，用于各种情况下，需要显示的标签</p>
<ul>
<li><code>name</code>                # 通用名，常为复数</li>
<li><code>singular_name</code>       # 单数形式</li>
<li><code>add_new</code>             # Add New submenu item</li>
<li><code>add_new_item</code>        # 列表页新建一个Post</li>
<li><code>edit_item</code></li>
<li><code>new_item</code></li>
<li><code>view_item</code></li>
<li><code>all_items</code></li>
<li><code>menu_name</code></li>
<li><code>name_admin_bar</code></li>
<li><code>search_items</code></li>
<li><code>not_found</code></li>
<li><code>not_found_in_trash</code></li>
<li><code>parent_item_colon</code></li>
</ul>
<h2>Post Type 相关的常用函数</h2>
<ul>
<li><code>get_post_types($args,$output,$operator)</code>    # 获取指定条件下的Post Types</li>
<li><code>get_post_type($post)</code>                       # 获取指定post的Post Type</li>
<li><code>post_type_exists($post_type)</code>               # 是否存在指定类型的Post Type</li>
<li><code>add_post_type_support($post_type,$sups)</code>    # 增加support</li>
<li><code>remove_post_type_support($post_type,$sups)</code> # 增加support</li>
<li><code>set_post_type($postid,$post_type)</code>          # 设置Post Type类型</li>
<li><code>is_post_type_hierarchical('super_duper')</code>   # 是否是有等级的</li>
</ul>

              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div class="container">
      <div class="container has-text-centered">
        <a href="posts/page29.html">
          Previous
        </a>
        31 of 32
        <a href="posts/page31.html">
          Next
        </a>
      </div>
    </div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.js"></script>
    <script>
       // 处理形如 <code>$E=mc^2$</code> 形式的公式
 var inlineMathNodes=document.querySelectorAll('code');
 var re=/^\$(.*)\$$/;
 for(var j=0;j<inlineMathNodes.length;j++){
   var result=re.exec(inlineMathNodes.item(j).innerText);
   if(result!==null){
	 katex.render(result[1], inlineMathNodes.item(j));
   }
 }
 function removeNode(node){
   if(node.remove){
	 node.remove();
   }else{
	 return first.parentNode.removeChild(node);
   }
 };

 // 查找所有 pre code.language-math 节点 以备筛出数据公式
 var nodes=document.querySelectorAll("pre code.language-math");
 for(var i=0;i<nodes.length;i++){
   var node=nodes.item(i);
   // 魔术标记所在行 
   try{
	 var lines = node.innerText.split('\n');
	 if((!!lines) && lines.length > 0)
	 {
	   var first = lines[0];
	   if(first.trim().match(/%%(\s?)*KaTeX(\s?)*/i)){
		 var views = "";
		 // 逐行渲染
		 for(var k=1; k <lines.length; k++){
			 var f=lines[k];
			 views += katex.renderToString(f);
		 }
		 // 消除父级嵌套 
		 try{
		   node.innerHTML=views;
		 }catch(e){
		   // IE9 don't support the method of assignning value to tr.innerHTML. Maybe the code below will be removed in the future
		   console.log('IE9 sucks',e);
		   $(tr).html(node.innerHTML);
		 }
	   }
	 }
   }
   catch(err){
	 console.log(err)
   }
 }
    </script>
    <script>
      hljs.highlightAll();
    </script>
  </body>
</html>