<!DOCTYPE html><html>
  <head>
    <meta charSet="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>
      Sample Fornax blog
    </title>
    <base href="/newbienewbie/"/>
    <script>
      document.addEventListener('DOMContentLoaded', () => {

	// Get all "navbar-burger" elements
	const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  
	// Check if there are any navbar burgers
	if ($navbarBurgers.length > 0) {
  
	  // Add a click event on each of them
	  $navbarBurgers.forEach( el => {
		el.addEventListener('click', () => {
  
		  // Get the target from the "data-target" attribute
		  const target = el.dataset.target;
		  const $target = document.getElementById(target);
  
		  // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
		  el.classList.toggle('is-active');
		  $target.classList.toggle('is-active');
  
		});
	  });
	}
  });
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"/>
    <link rel="stylesheet" href="https://unpkg.com/bulma@0.8.0/css/bulma.min.css"/>
    <link rel="stylesheet" type="text/css" href="style/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/atom-one-dark-reasonable.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" href="">
            <img src="images/bulma.png" alt="Logo"/>
          </a>
          <span class="navbar-burger burger" data-target="navbarMenu">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </div>
        <div id="navbarMenu" class="navbar-menu">
          <a class="navbar-item" href="">
            Home
          </a>
          <a class="navbar-item" href="tags.html">
            Tags
          </a>
          <a class="navbar-item" href="about.html">
            About
          </a>
          <a class="navbar-item" href="contact.html">
            Contact
          </a>
        </div>
      </div>
    </nav>
    <section class="hero is-info is-medium is-bold">
      <div class="hero-body">
        <div class="container has-text-centered">
          <h1 class="title">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit
          </h1>
        </div>
      </div>
    </section>
    <div class="container">
      <section class="articles">
        <div class="column is-8 is-offset-2">
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/ECMAScript/SequelizeJS/关联查询.html">
                    关联查询
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        ECMAScript
                      </a>
                    </li>
                    <li>
                      <a href="">
                        Sequelize
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <span class="tag is-info">
                    ECMAScript
                  </span>
                  <span class="tag is-info">
                    Node.js
                  </span>
                  <span class="tag is-info">
                    Sequelize
                  </span>
                  <span class="tag is-info">
                    ORM
                  </span>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2017-02-18
                </p>
              </div>
              <div class="content article-body">
                <h2>模型关联定义</h2>
<p>假设现有一个文章表post、文章分类表category、用户表（视作作者表）user</p>
<ul>
<li>post 和 category 是 <code>N:1</code>关系，外键为<code>category_id</code></li>
<li>post 和 user 是<code>N:1</code>关系，外键为<code>author_id</code></li>
</ul>
<p>假定<code>Sequelize</code>定义的各个<code>model</code>的所有字段都采用<code>camelCase</code>风格，而数据库及其中的表、字段命名一律采用下划线风格。</p>
<pre><code class="language-JavaScript">// post.js
module.exports = function(sequelize, DataTypes) {
  return sequelize.define('post', {

    title: {
      type: DataTypes.STRING,
      allowNull: false,
    },

    // ... 其他字段省略

    // 定义作者ID
    authorId: {
      type: DataTypes.INTEGER,
      allowNull: true,
      field:'author_id',
    },
    // 定义分类ID
    categoryId: {
      type: DataTypes.INTEGER,
      allowNull:false,
      field:'category_id'
    },
    
  }, {
    tableName: 'post'
  });
};
</code></pre>
<p>现将定义的模型关联如下：</p>
<pre><code class="language-JavaScript">// 声明 post 和 category 之间 N:1 联系
post.belongsTo(category);

// 声明 post 和 category 之间 N:1 联系，指定二者之间通过外键`author_id`关联
post.belongsTo(user,{foreignKey:'author_id'})
</code></pre>
<h2>懒加载</h2>
<p>默认情况下（也就是不指定<code>include</code>数组），<code>Sequelize</code>执行的是懒加载——仅仅只查询指定的模型，与之关联的模型则可以通过</p>
<ul>
<li><code>get{TargetModel}()</code></li>
<li><code>set{TargetModel}()</code></li>
</ul>
<p>方法获取和设置。</p>
<p>再假如有这样的一个关联：</p>
<pre><code class="language-JavaScript">user.belongsTo(
    picture, 
    { 
        as: 'ProfilePicture', 
        constraints: false 
    }
)
</code></pre>
<p>则 user 就拥有方法：</p>
<pre><code class="language-JavaScript">user.getProfilePicture();
</code></pre>
<h2>急加载</h2>
<p>懒加载有一个弊端是，如果要获取关联信息，需要执行多次<code>SQL</code>查询，这显然在有些场景下并不合适。</p>
<h3><code>include</code></h3>
<p>现要对文章的作者、分类也一并进行查询，可以通过传递选项的<code>include</code>进行查询：</p>
<pre><code class="language-JavaScript">domain.post.findAll({
    where:{
        // status:'approval',
    },
    include:[
        {
            model:domain.category,
        },
        {
            model:domain.user,
        },
    ],
})
</code></pre>
<p>则会被转为<code>left join</code>：</p>
<pre><code class="language-SQL">SELECT 
    `post`.`id`, -- 其他字段省略
    `post`.`author_id` AS `authorId` ,    -- 模型定义中的外键字段
    `post`.`category_id` AS `categoryId`, -- 模型定义中的外键字段 
    `post`.`author_id`,                   -- 这里再追加一个定义关联时指定的外键
    `category`.`id` AS `category.id`,     -- 其他字段省略
    `user`.`id` AS `user.id`,             -- 其他字段省略
FROM `post` AS `post` 
LEFT OUTER JOIN `category` AS `category` 
    ON `post`.`category_id` = `category`.`id` 
LEFT OUTER JOIN `user` AS `user` 
    ON `post`.`author_id` = `user`.`id`;
</code></pre>
<p>注意，如果<code>include</code>数组项中除了指定<code>model</code>之外，还指定了<code>where</code>条件，则对应的<code>model</code>连接方式会被转化为<code>inner join</code>:</p>
<pre><code class="language-JavaScript">domain.post.findAll({
    where:{
        status:'approval',
    },
    include:[
        {
            model:domain.category,
            where:{
                id:3
            }
        },
        {
            model:domain.user,
        },
    ],
});
</code></pre>
<p>对应的SQL语句为（注意看两个where条件）：</p>
<pre><code class="language-SQL">SELECT 
    `post`.`id`,                      -- 其他字段省略 
    `category`.`id` AS `category.id`, -- 其他字段省略
    `user`.`id` AS `user.id`          -- 其他字段省略
FROM `post` AS `post` 
INNER JOIN `category` AS `category` 
    ON `post`.`category_id` = `category`.`id` AND `category`.`id` = 3 
LEFT OUTER JOIN `user` AS `user` 
    ON `post`.`author_id` = `user`.`id`
WHERE `post`.`status` = 'approval';
</code></pre>
<h3>急加载的 as 问题</h3>
<p>之前定义关联的时候，对 author 是直接使用 user，并指定了一个外键：</p>
<pre><code class="language-JavaScript">post.belongsTo(user,{foreignKey:'authorId'})
</code></pre>
<p>这样急加载查询后得到的结果类似于：</p>
<pre><code>[
    {
        id:1,
        title:'',
        categoryId:2,
        category:{id:2,/*其余省略*/},
        authorId:1,    // 这里是模型中定义的字段
        author_id:1,   // 这里是追加的外键关联字段
        user:{id:1,/*其余省略*/},
    },
    // ...
]
</code></pre>
<p>如果我们想把这里的<code>user</code>改为<code>author</code>,则需要在定义管理和急加载查询两个地方都进行改动：</p>
<p>在定义关联的时候指定<code>as</code>：</p>
<pre><code class="language-JavaScript">post.belongsTo(user,{foreignKey:'author_id',as:'author'});
</code></pre>
<p>一旦在定义管理的时候指定了<code>as</code>,在急加载查询的时候也必须要指定<code>as</code>，否则会报错：</p>
<pre><code>Unhandled rejection Error: user is not associated to post!
</code></pre>
<p>其中的具体原因在于仅仅告诉<code>Sequelize</code>要急加载的模型信息是不够的。不妨考虑有一个 uesr 表、picture 表，满足这这样的关系：</p>
<ul>
<li>user用于存储用户信息</li>
<li>picture用于存储用户的普通图片和头像</li>
<li>每个user可以拥有多个普通picture，</li>
<li>一个普通picture必定属于某个用户</li>
<li>每个profilePicture可以被多个用户同时使用，</li>
<li>一个用户只能拥有一个profilePicture。</li>
</ul>
<p>于是，</p>
<ol>
<li>在user和picture之间可以是<code>1:N</code>,</li>
<li>在user和 profilePicture 之间则是 <code>N:1</code>关系</li>
</ol>
<p>二者关联定义如下：</p>
<pre><code class="language-JavaScript">user.hasMany(picture);
user.belongsTo(
    picture, 
    { 
        as: 'profilePicture', 
        constraints: false 
    }
);
</code></pre>
<p>于是，两个模型 user 和 picture 之间就同时拥有了两种关联关系。由于有这种情况的存在，<code>Sequelize</code>是无法只根据模型名推算出要急加载的到底是普通的 picture 还是 profilePicture 的。</p>
<p>所以，一旦在定义关联时候指定了别名，当需要急加载时，除了指定模型名，还必须告诉<code>Sequelize</code>模型名的别名：</p>
<pre><code class="language-JavaScript">domain.post.findAll({
    where:{
        // status:'approval',
    },
    include:[
        {
            model:domain.category,
        },
        {
            model:domain.user,
            as:'author'
        },
    ],
})
</code></pre>
<p>这样，返回的结果集类似于：</p>
<pre><code class="language-JavaScript">[
    {
        &quot;id&quot;:1,
        &quot;categoryId&quot;:2,
        &quot;category&quot;:{&quot;id&quot;:2,/*其他字段省略*/},
        &quot;authorId&quot;:1,
        &quot;author_id&quot;:1,
        &quot;author&quot;:{&quot;id&quot;:1,/*其他字段省略*/},
    },
]
</code></pre>

              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.js"></script>
    <script>
       // 处理形如 <code>$E=mc^2$</code> 形式的公式
 var inlineMathNodes=document.querySelectorAll('code');
 var re=/^\$(.*)\$$/;
 for(var j=0;j<inlineMathNodes.length;j++){
   var result=re.exec(inlineMathNodes.item(j).innerText);
   if(result!==null){
	 katex.render(result[1], inlineMathNodes.item(j));
   }
 }
 function removeNode(node){
   if(node.remove){
	 node.remove();
   }else{
	 return first.parentNode.removeChild(node);
   }
 };

 // 查找所有 pre code.language-math 节点 以备筛出数据公式
 var nodes=document.querySelectorAll("pre code.language-math");
 for(var i=0;i<nodes.length;i++){
   var node=nodes.item(i);
   // 魔术标记所在行 
   try{
	 var lines = node.innerText.split('\n');
	 if((!!lines) && lines.length > 0)
	 {
	   var first = lines[0];
	   if(first.trim().match(/%%(\s?)*KaTeX(\s?)*/i)){
		 var views = "";
		 // 逐行渲染
		 for(var k=1; k <lines.length; k++){
			 var f=lines[k];
			 views += katex.renderToString(f);
		 }
		 // 消除父级嵌套 
		 try{
		   node.innerHTML=views;
		 }catch(e){
		   // IE9 don't support the method of assignning value to tr.innerHTML. Maybe the code below will be removed in the future
		   console.log('IE9 sucks',e);
		   $(tr).html(node.innerHTML);
		 }
	   }
	 }
   }
   catch(err){
	 console.log(err)
   }
 }
    </script>
    <script>
      hljs.highlightAll();
    </script>
  </body>
</html>