<!DOCTYPE html><html>
  <head>
    <meta charSet="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>
      Sample Fornax blog
    </title>
    <base href="/newbienewbie/"/>
    <script>
      document.addEventListener('DOMContentLoaded', () => {

	// Get all "navbar-burger" elements
	const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  
	// Check if there are any navbar burgers
	if ($navbarBurgers.length > 0) {
  
	  // Add a click event on each of them
	  $navbarBurgers.forEach( el => {
		el.addEventListener('click', () => {
  
		  // Get the target from the "data-target" attribute
		  const target = el.dataset.target;
		  const $target = document.getElementById(target);
  
		  // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
		  el.classList.toggle('is-active');
		  $target.classList.toggle('is-active');
  
		});
	  });
	}
  });
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"/>
    <link rel="stylesheet" href="https://unpkg.com/bulma@0.8.0/css/bulma.min.css"/>
    <link rel="stylesheet" type="text/css" href="style/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/atom-one-dark-reasonable.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" href="">
            <img src="images/bulma.png" alt="Logo"/>
          </a>
          <span class="navbar-burger burger" data-target="navbarMenu">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </div>
        <div id="navbarMenu" class="navbar-menu">
          <a class="navbar-item" href="">
            Home
          </a>
          <a class="navbar-item" href="tags.html">
            Tags
          </a>
          <a class="navbar-item" href="about.html">
            About
          </a>
          <a class="navbar-item" href="contact.html">
            Contact
          </a>
        </div>
      </div>
    </nav>
    <section class="hero is-info is-medium is-bold">
      <div class="hero-body">
        <div class="container has-text-centered">
          <h1 class="title">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit
          </h1>
        </div>
      </div>
    </section>
    <div class="container">
      <section class="articles">
        <div class="column is-8 is-offset-2">
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/Symfony/Symfony-EventDispatcher.html">
                    Symfony EventDispather
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        Symfony
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <span class="tag is-info">
                    Symfony
                  </span>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <h2>Event和EventDispatcher</h2>
<p>Event是什么？</p>
<p>其实很简单，Event是用于描述“what happens?” 的东西。正因为此，Event对象中通常包含了一些数据，用来表示发生了什么。事实上，事件对象只是在描述发生了什么—准确的说，事件对象提供了一个接口，让别人知道发生了什么。</p>
<p>Symfony/EventDispather 提供了Event基础类来描述“What Happens”，这个基础类非常简单，只是对以下信息进行抽象：</p>
<ul>
<li>Event调度器是谁？（dispatcher属性及getter/setter）</li>
<li>Event是否还能传播？（propagationStopped属性及getter/setter）</li>
<li>Event叫什么名字？（deprecated:name属性及getter/setter））</li>
</ul>
<p>对于包含特殊信息的特定事件，可以继承自Event类，再添加自己对该类事件的特殊属性的抽象。比如：</p>
<pre><code class="language-PHP">class FilterOrderEvent extends Event{

    protected $order;
	public function __construct(){
	    $this-&gt;order=$order;
	}
	
	public function getOrder(){
	    return $this-&gt;getOrder();
	}

}
</code></pre>
<p>这样，FilterOrderEvent事件除了包含Event基础类中那些对发生了什么的描述，还增加了对order这类信息的描述（提供了getOrder()接口让其他人获取Order对象）。</p>
<p>再比如，Symfony/Form组件中的FormEvent类，除了基础的Event属性外，还添加了两个额外属性:</p>
<pre><code class="language-PHP">class FormEvent extends Event
{
    private $form;
    protected $data;
    
    public function __construct(FormInterface $form, $data)
    {
        $this-&gt;form = $form;
        $this-&gt;data = $data;
    }
    
    //....
}
</code></pre>
<p>一个是实现了FormInterface的表单对象$form，代表与当前事件相关的是哪个表单;一个是混合类型的$data参数，用于对特定数据的动态修改，如modelData之类。</p>
<p>很多时候，我们并不仅仅想知道发生了什么，我们还想根据发生了什么做出相应的动作。关于这一点，可以参见Wiki给出的Event定义：</p>
<blockquote>
<p>In computing, an event is an action or occurrence detected by the program that may be handled by the program</p>
</blockquote>
<p>这段话说明了一点很重要的东西：事件应当可以被检测、处理。通常由事件监听器(event listener)或者说事件处理器(event handle)来完成这一工作。</p>
<p>Symfony/EventDispather组件提供了这类对事件发布、调度、监听的功能。</p>
<p>EventDispather对象的dispatch()方法会根据某一个事件对应的Listeners,按优先级逐一进行调用。EventDispather支持两套风格事件处理程序的绑定。最常用的是addListener(),这是一种快速编码的回调风格，类似于JavaScript中的回调函数。还有一种使用Subscriber对象的风格。</p>
<h2>使用具有回调风格的Listener</h2>
<p>添加监听器的方法原型为：</p>
<pre><code class="language-PHP">addListener($eventName,$listener,$priority=0)
</code></pre>
<p>这一方法的关键特征是:传递给addListener的第二个参数是一个callable对象。这十分类似于JavaScript的回调函数:</p>
<pre><code class="language-PHP">
$dispather-&gt;addListener(
    'foo.action',
    array($listener,'onFooAction')       //a PHP callable
);

$dispather-&gt;addListener(
    'bar.action',
    function(Event $event){              //a PHP callable
        //...
    }
);
</code></pre>
<h2>使用EventSubscriber对象</h2>
<p>EventDispather还支持另外一种风格的监听绑定：</p>
<pre><code class="language-PHP">addSubscriber(EventSubscriberInterface $subscriber);
</code></pre>
<p>此方法接受一个实现了EventSubscriberInterface接口的对象作为参数。该接口非常简单：</p>
<pre><code class="language-PHP">interface EventSubscriberInterface
{
    public static function getSubscribedEvents();
}
</code></pre>
<p>接口方法getSubscribedEvents()返回一个数组，该数组可以是三种方式中的一种：</p>
<ul>
<li>array('eventName' =&gt; 'methodName')</li>
<li>array('eventName' =&gt; array('methodName', $priority))</li>
<li>array('eventName' =&gt; array(array('methodName1', $priority), array('methodName2'))</li>
</ul>
<p>addSubscriber()方法会自动检测接收到的$subscriber对象并解析出合适的方法名，再通过过addListener()方法完成事件绑定监听。其源码及实现分析如下：</p>
<pre><code class="language-PHP">
    public function addSubscriber(EventSubscriberInterface $subscriber)
    {
        foreach ($subscriber-&gt;getSubscribedEvents() as $eventName =&gt; $params) {

            //$subscripter-&gt;getSubscribedEvents   返回的数组类似于: 
            //    array(
            //        'eventName'=&gt;&quot;methodName&quot;,
            //         //... 
            //    )
            if (is_string($params)) {
                $this-&gt;addListener($eventName, array($subscriber, $params));
            }

            //$subscripter-&gt;getSubscribedEvents   返回的数组类似于: 
            //    array(
            //        'eventName'=&gt;array(&quot;methodName&quot;,$priority),
            //         //... 
            //    )
             elseif (is_string($params[0])) {      
                $this-&gt;addListener($eventName, array($subscriber, $params[0]), isset($params[1]) ? $params[1] : 0);
             } 

            //$subscripter-&gt;getSubscribedEvents   返回的数组类似于: 
            //    array(
            //        'eventName'=&gt;array(
            //            array(&quot;methodName1&quot;,$priority)
            //            array(&quot;methodName22&quot;)
            //         ),
            //        //... 
            //    )
             else {
                foreach ($params as $listener) {
                    $this-&gt;addListener($eventName, array($subscriber, $listener[0]), isset($listener[1]) ? $listener[1] : 0);
                }
            }
        }
    }
</code></pre>
<p>可以看到，addSubscriber()始终都是把形如<code>array($subscriber,$methodName)</code>这样的callable传递给addListener。显而易见，一个Subscrber应该有如下的类似形式：</p>
<pre><code class="language-PHP">class StoreSubscriber implements EventSubscriberInterface{
    
    public static function getSubscribedEvents(){
        return array(
            'kernel.repsonse'=&gt;array(
                array('onKernelResponsePre',10),
                array('onKernelResponseMid',5),
                array('onKernelResponsePost',0),
            ),
            'store.order'=&gt;array('onStoreOrder',0)
        );
    }


    public static function onKernelResponsePre{
        //...
    }

    public static function onKernelResponseMid{
        //...
    }

    public static function onKernelResponsePost{
        //...
    }

    public static function onStoreOrder{
        //...
    }
}
</code></pre>
<p>这种十分类似于Java Swing中事件监听接口，比如MouseListener类：</p>
<pre><code class="language-Java">button.addMouseListener(new MouseListener() {

    @Override
    public void mouseClicked(MouseEvent e) {
        System.out.println(&quot;mouseClicked&quot;);
    }

    @Override
    public void mousePressed(MouseEvent e) {
        System.out.println(&quot;鼠标被按住&quot;);
    }


    @Override
    public void mouseReleased(MouseEvent e) {
        System.out.println(&quot;鼠标被释放&quot;);

    }

    @Override
    public void mouseEntered(MouseEvent e) {

        System.out.println(&quot;鼠标被进入&quot;);
    }

    @Override
    public void mouseExited(MouseEvent e) {
        System.out.println(&quot;鼠标被退出&quot;);
    }
});
</code></pre>
<p>Symfony中的EventSubscriber对象为一组事件监听器提供了良好的组织形式，使得代码更具有可读性。</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.js"></script>
    <script>
       // 处理形如 <code>$E=mc^2$</code> 形式的公式
 var inlineMathNodes=document.querySelectorAll('code');
 var re=/^\$(.*)\$$/;
 for(var j=0;j<inlineMathNodes.length;j++){
   var result=re.exec(inlineMathNodes.item(j).innerText);
   if(result!==null){
	 katex.render(result[1], inlineMathNodes.item(j));
   }
 }
 function removeNode(node){
   if(node.remove){
	 node.remove();
   }else{
	 return first.parentNode.removeChild(node);
   }
 };

 // 查找所有 pre code.language-math 节点 以备筛出数据公式
 var nodes=document.querySelectorAll("pre code.language-math");
 for(var i=0;i<nodes.length;i++){
   var node=nodes.item(i);
   // 魔术标记所在行 
   try{
	 var lines = node.innerText.split('\n');
	 if((!!lines) && lines.length > 0)
	 {
	   var first = lines[0];
	   if(first.trim().match(/%%(\s?)*KaTeX(\s?)*/i)){
		 var views = "";
		 // 逐行渲染
		 for(var k=1; k <lines.length; k++){
			 var f=lines[k];
			 views += katex.renderToString(f);
		 }
		 // 消除父级嵌套 
		 try{
		   node.innerHTML=views;
		 }catch(e){
		   // IE9 don't support the method of assignning value to tr.innerHTML. Maybe the code below will be removed in the future
		   console.log('IE9 sucks',e);
		   $(tr).html(node.innerHTML);
		 }
	   }
	 }
   }
   catch(err){
	 console.log(err)
   }
 }
    </script>
    <script>
      hljs.highlightAll();
    </script>
  </body>
</html>