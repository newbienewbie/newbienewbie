---
layout: post
title: PLC基本原理——世界观 
date: 2018-1-16 21:41:30
tags:
- IoT
- PLC 
categories:
- 风语
- IoT
- PLC
---

可编程控制器(`Programmable Logic Controller`,`PLC`) 是一种专门为工业环境下应用而设计的数字运算操作的电子装置，`PLC`是在电器控制技术和计算机技术的基础上发展起来的。在`PLC`之前，大规模应用的是继电器，但是继电器体积大、接线复杂、可复用性差、速度慢、不易更改、适应性差，为了克服这些缺点，在1969年美国数字公司研制出了世界第一台PLC，开创了工业控制领域的新纪元。相比于继电器控制，`PLC`具有以下优点：
* 高可靠性
* I/O接口模块多
* 模块化结构
* 编程简单
* 安装简单、维修方便

## 基本结构

`PLC`最基本的结构主要有： <!--more-->
* `CPU`
* 存储器：
    * `RAM`
    * `ROM`
* `I/O`模块
    * 输出接口: 包括`DO`、`AO`两种，常见的`DO`包括以下三种：
        * 继电器输出型：触点输出，机械寿命长，动作慢
        * 晶体管输出型: 主要用于高频小功率负载回路
        * 晶闸管输出型: 耐压高，负载能力强，可用于大功率交流回路
    * 输入接口：通过`PLC`的输入端子接收现场输入设备的控制信号，包括`DI`、`AI`两种。输入信号通过光耦合器传送给内部电路，二者之间并无电的联系，这种隔断措施可以避免现场干扰。外部输入多为220V AC 或者 24V AC，内部工作电压多为5V。
    *  I/O扩展接口: 用于扩展I/O点数。
* 电源模块
* 机架/底板

## 基本工作原理

概括来说，`PLC`是以不断循环的顺序扫描方式工作的，每次扫描所用时间称之为工作周期。`CPU`将从第一条指令开始，按顺序逐条执行用户程序，直到程序结束，然后开始新一轮扫描，周而复始。这种方式称之为“巡回扫描”。

1. 上电处理（电源ON -->  内部处理）
2. 扫描过程
    * 2.1 输入处理（输入传送、远程I/O）
    * 2.2 通信服务（外设、CPU、总线服务） 
    * 2.3 更新时钟、特殊寄存器
    * 2.4 若CPU运行方式为`RUN`，则运行程序、然后进行输出处理；若`CPU`为`STOP`，则直接跳到下一步
    * 2.5 执行自诊断，若PLC正常，则开始下一轮扫描过程；否则进入出错处理环节
3. 出错处理
    * 存放自诊断结果
    * 若非致命错误，进入下一轮扫描过程；若为致命错误，将CPU转为`STOP`状态，再进入下一轮扫描过程


`PLC`的扫描过程主要分为三步：
1. 输入扫描：读入`PLC`上所有输入端子的输入信号，存入输入映像寄存器。
2. 执行扫描：从上到下顺序执行指令，从输入状态映像寄存器读入数据，做逻辑运算/算术运算，将结果写入输出映像区。
3. 输出扫描：将`PLC`输出状态映象寄存器的内容同时送入输出锁存器（称之为输出刷新），然后有锁存器经过功率放大后，把信号输出到输出端子。

## PLC编程

可见，`PLC`的工作可以类比于一个函数，接受一定输入，通过相应的计算，得到特定的输出。涉及到的存储器主要包括:
* 外部输入（为了方便，后文用尽量采用记号`X`表示）
* 外部输出（为了方便，后文尽量采用记号`Y`表示）
* 内部寄存器（为了方便，后文尽量采用记号`R`表示）
* 定时器（为了方便，后文尽量采用记号`T`表示）
* 计数器（为了方便，后文尽量采用记号`C`表示）

### 梯形图与助记符语言

梯形图是通过连线表示把`PLC`指令的梯形图符号连到一起的连通图，由于沿用了传统继电器接触控制的术语和符号，故使得其称为最广泛使用的`PLC`编程语言。助记符语言则与汇编语言非常类似，采用文字符号表达各种指令，由于各厂商提供的方言各不相同，所以助记符语言的移植性并不好。但是助记符语言便于书写、指令清晰，对于熟悉编程的人非常容易理解。例如，我们假设有如下记号(`token`)来表达相关指令:
* `ST` : 表示`START`
* `ED` : 表示`END`
* `AN` : 表示逻辑`AND`
* `OR` : 表示逻辑`OR`
* `/`  : 表示逻辑`NOT`
* `OT` :`OUTPUT`，指的是把当前运算结果输出到指定点

举一个简单例子，假设有输入端子`X0`，目标输出为`Y0`、`Y1`，现有如下代码：
```asm
ST   X 0
OT   Y 0
ST/  X 0
OT   Y 1
ED         
```
从指令上理解，可以想象有个栈式机器，先读入`X0`，然后将机器当前状态值输出到`Y0`；再将读入`X0`后取反作为机器当前状态，再将机器当前状态值输出到`Y1`。从功能上讲，这段代码表示当继电器`X0`闭合时，接通`Y0`；当`X0`断开时，接通`Y1`。

助记符语言可以等价转换为梯形图语言。

### 应用举例

```asm
ST    X 0
OT    Y 0
/ 
OT    Y 1
```
表示
* 当`XO`闭合，`Y0`接通，`Y1`断开
* 当`X0`断开，`Y0`断开，`Y1`接通

再看一个比这个稍稍复杂一点点的例子，首先引入跟栈相关的三个指令：
* `PSHS` : 把当前值压入栈中
* `POPS` : 弹出栈首
* `RDS`  : 读取栈首

考虑有下面一段程序（为了更清晰的表达意图，我对程序做了缩进处理）:
```asm
ST X 0
    PSHS 
        AN X 1
        OT Y 1
    RDS
        AN X 2
        OT Y 2
    POPS
        AN X 3
        OT Y 3
```
表示把`X0`依次和`X1`、`X2`、`X3`分别做与运算，相应的三个输出分别为`Y1`、`Y2`、`Y3`。从功能上讲，可以把`X0`想象成是总开关，而`X1`、`X2`、`X3`分别是用于控制`Y1`、`Y2`、`Y3`的三个开关。
