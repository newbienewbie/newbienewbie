<!DOCTYPE html><html>
  <head>
    <meta charSet="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>
      Sample Fornax blog
    </title>
    <base href="/newbienewbie/"/>
    <script>
      document.addEventListener('DOMContentLoaded', () => {

	// Get all "navbar-burger" elements
	const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  
	// Check if there are any navbar burgers
	if ($navbarBurgers.length > 0) {
  
	  // Add a click event on each of them
	  $navbarBurgers.forEach( el => {
		el.addEventListener('click', () => {
  
		  // Get the target from the "data-target" attribute
		  const target = el.dataset.target;
		  const $target = document.getElementById(target);
  
		  // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
		  el.classList.toggle('is-active');
		  $target.classList.toggle('is-active');
  
		});
	  });
	}
  });
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"/>
    <link rel="stylesheet" href="https://unpkg.com/bulma@0.8.0/css/bulma.min.css"/>
    <link rel="stylesheet" type="text/css" href="style/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/atom-one-dark-reasonable.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" href="">
            <img src="images/bulma.png" alt="Logo"/>
          </a>
          <span class="navbar-burger burger" data-target="navbarMenu">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </div>
        <div id="navbarMenu" class="navbar-menu">
          <a class="navbar-item is-active" href="">
            Home
          </a>
          <a class="navbar-item" href="tags.html">
            Tags
          </a>
          <a class="navbar-item" href="about.html">
            About
          </a>
          <a class="navbar-item" href="contact.html">
            Contact
          </a>
        </div>
      </div>
    </nav>
    <section class="hero is-info is-medium is-bold">
      <div class="hero-body">
        <div class="container has-text-centered">
          <h1 class="title">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit
          </h1>
        </div>
      </div>
    </section>
    <div class="container">
      <section class="articles">
        <div class="column is-8 is-offset-2">
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/model-layer/Model-Layer.html">
                    WordPress Model Layer
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <p>WordPress虽说并不和现代的MVC模式一致,但是也有独立的数据库操作层。</p>
<h1>全局对象$wpdb</h1>
<p>有一个全局对象$wpdb 作为WPINC/wp-db.php中的wpdb类实例对象。该类是
<code> WordPress Database Access Abstraction</code>。</p>
<p>可以用其他的类替换之。</p>
<h2>Adding Data</h2>
<p>利用$wpdb-&gt;insert()方法，此方法接受三个参赛：</p>
<ol>
<li>表名</li>
<li>数组，字段的名和值对组成的数组</li>
<li>数组，可选的格式</li>
</ol>
<pre><code class="language-PHP">$wpdb-&gt;insert(
   $wpdb-&gt;posts,
   array(
       'post_title'=&gt;'xx',
       'post_content'=&gt;'xx',
       'post_type'=&gt;'xx',
   ),
   array(&quot;%s&quot;,%s&quot;,&quot;%s&quot;)
);
</code></pre>
<h2>update</h2>
<p>利用$wpdb-&gt;update()方法，此方法接受5个参数：</p>
<ol>
<li>表名</li>
<li>新记录的数组表示，由各字段的名/值对组成的数组</li>
<li>where条件数组</li>
<li>数组,每个元素表示新记录中的值的格式</li>
<li>数组，表示where条件数组的格式</li>
</ol>
<pre><code class="language-PHP">$wpdb-&gt;update(
    $wpdb-&gt;posts,
    array(
       'post_title'=&gt;'new',
       'post_content'=&gt;'new',
       'post_type'=&gt;'new',
    ),
    array(
       'ID'=&gt;$post_id,
    ),
    array(&quot;%s&quot;,&quot;%s&quot;),
    array(&quot;%s&quot;)
);
</code></pre>
<h2>Delete</h2>
<p>$wpdb-&gt;delte()方法可以用来删除行记录。 原型为</p>
<pre><code class="language-PHP">public function delete( $table, $where, $where_format = null ) 
</code></pre>
<p>例如：</p>
<pre><code class="language-PHP">$wpdb-&gt;delete( 'table', array( 'ID' =&gt; 1 ), array( '%d' ) );
</code></pre>
<h2>Retrieving</h2>
<h3>获取单个值</h3>
<pre><code class="language-PHP">$post_id=$wpdb-&gt;get_var(
    &quot;select ID from &quot;.$wpdb-&gt;posts.&quot; where post_author=1 limit 1&quot;
);
</code></pre>
<h3>获取一列值</h3>
<pre><code class="language-PHP">$wpdb-&gt;get_col(
    &quot;select ID from &quot;.$wpdb-&gt;posts.&quot; where post_author=1 &quot;,
    ARRAY_A    # NULL|ARRAY_A|ARRAY_N,默认为object格式的返回值，
);
</code></pre>
<h3>获取一行值</h3>
<pre><code class="language-PHP">$wpdb-&gt;get_row(
    &quot;select * from &quot;.$wpdb-&gt;users.&quot; where ID=43;&quot;,
    ARRAY_N    #NULL|ARRAY_A|ARRAY_N
);
</code></pre>
<h3>获取完整的数据集</h3>
<pre><code class="language-PHP">$wpdb-&gt;get_results(
    &quot;select * from &quot;.$wpdb-&gt;users.a&quot;,
    ARRAY_N    #NULL|ARRAY_A|ARRAY_N
);
</code></pre>
<h2>执行查询</h2>
<pre><code class="language-PHP">$wpdb-&gt;query(string SqlString);
</code></pre>
<h2>SQL 注入与防御</h2>
<p>WordPress 使用<code>$wpdb-&gt;prepare()</code>防御SQL注入。此方法使用PHP printf()函数的语法为字段进行代换，
如同printf()那样，这里的占位符也可以使用排序索引。</p>
<pre><code>$sanitized_sql=$wpdb-&gt;prepare(
    &quot;'insert into my_plugin_table set field1=%1$d,$field2=$2$s,$field=%3$s,32',32,'Barzell','Washington,DC'&quot;
);
$wpdb-&gt;query($sanitized_sql);
</code></pre>

              </div>
            </div>
          </div>
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/architecture/architecture4-overall.html">
                    WordPress 前台基础架构分析之四：总览
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <h2>核心函数基本构成</h2>
<p>WordPress核心文件包含了绝大部分WordPress流行函数，均位于<code>wp-includes/</code>文件夹下。</p>
<ul>
<li>functions.php     # main API</li>
<li>options.php       # Options API</li>
<li>plugin.php        # Plugin API</li>
<li>User.php          # User API</li>
<li>Post.php          # Post API</li>
<li>Taxnonmy.php      # Taxnonmy API</li>
<li>formatting.php    # Formatting Functions</li>
<li>pluggable.php     # 可覆盖的API</li>
<li>..，</li>
</ul>
<p>这些众多的文件定义了众多API，常见的有：</p>
<ul>
<li>Plugin API</li>
<li>Widgets API</li>
<li>Shortcode API</li>
<li>HTTP API          # 发送HTTP请求</li>
<li>Settings API</li>
<li>Options API</li>
<li>Dashboard Widgets API</li>
<li>Rewrite API</li>
</ul>
<h2>再看Loop时的全局变量</h2>
<p>前文已经说到，WordPress的博客功能其实就是再做三件事:</p>
<ol>
<li>加载必要的文件</li>
<li>根据条件查询数据库，然后保存到全局对象或者全局对象中。</li>
<li>根据查询后的结果，选择加载合适的模板。</li>
</ol>
<p>Loop时设置的关键的全局变量有：</p>
<ul>
<li>Post Dtata : <code>$post</code></li>
<li>Author Data : <code>$autordata</code></li>
<li>User Data : <code>$current_user</code></li>
<li>Environment Data: 环境变量
<ul>
<li>客户端：<code>$is_IE</code>,<code>$is_iphone</code>,<code>$is_mobile</code>,...</li>
<li>服务端： <code>$is_apache</code>,<code>$is_IIS</code></li>
</ul>
</li>
</ul>
<p>WordPress定义的Template Tag 会根据全局变量的不同，给出相应的值（或者默认值）。</p>
<p>因此，应该优先调用Template Tag而非使用全局对象或者变量。</p>

              </div>
            </div>
          </div>
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/architecture/Capabilities.html">
                    WordPress Capabilities
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <h2>内置的Roles与Capabilities</h2>
<p>WordPress内置了以下的角色(Roles)：</p>
<ol>
<li>Super Admin</li>
<li>Administrator</li>
<li>Editor</li>
<li>Author</li>
<li>Contributor</li>
<li>Subscriber</li>
</ol>
<p>没个角色都拥有特定的capabilities，诸如:read类、 edit类、 delete类、 publish类、 manage categories类、 manage links类、 moderate comments类、 upload files类、 remove users类等等。</p>
<p>WordPress中capabilities分为两种：</p>
<ul>
<li>permitive   表示一个指定角色能否做一件事儿</li>
<li>meta     用于根据上下文语境来确定一个指定用户能否做一件事儿</li>
</ul>
<p>二者的重要区别是，前者针对的是Role，是宽泛性的，常为复数；后者一般针对的是User，为单数。</p>
<p><code>map_meta_cap()</code> translates a user's primitive capabilities to his/her meta capabilities.</p>
<h2>WordPress的用户-角色原理</h2>
<h3>基本思想</h3>
<p>从本质上说，角色能力控制的基础是要表达这样的一种信息：</p>
<ol>
<li>角色集合的管理: 都有哪些角色？如何增加、删除和修改角色。</li>
<li>角色能力管理: 都有哪些能力？如何增加、删除、和修改能力</li>
</ol>
<p>可以表达为这样的PHP数组形式：</p>
<pre><code class="language-PHP">array (

  	'role1' =&gt; array (
  		'name' =&gt; 'rolename1',
  		'capabilities' =&gt; array(
            'cap1'=&gt;true,
            'cap2'=&gt;false,
            //...
        )
  	),

  	'role2' =&gt; array (
  		'name' =&gt; 'rolename2',
  		'capabilities' =&gt; array(
            'cap1'=&gt;true,
            'cap2'=&gt;false,
            //...
        )
  	),

    //...

)
</code></pre>
<h3>文件定义概述</h3>
<p>为了实现上述功能，WordPress的<code>wp-includes/capabilities.php</code>文件定义了这样几个类：</p>
<ul>
<li><code>WP_Roles</code>    # 管理一系列<code>WP_Role</code>的类，其有一个全局类实例<code>$wp_roles</code></li>
<li><code>WP_Role</code>     # 管理一个角色的capabilities</li>
<li><code>WP_User</code>     # 管理用户</li>
</ul>
<p>和这样的几个函数：</p>
<ul>
<li><code>map_meta_cap($cap,$user_id)</code></li>
<li><code>current_user_can($capability)</code></li>
<li><code>current_user_can_for_blog( $blog_id, $capability )</code></li>
<li><code>author_can($post,$capability)</code></li>
<li><code>user_can($post,$capability)</code></li>
<li><code>wp_roles()</code>         #获取全局的<code>WP_Roles</code>实例</li>
<li><code>get_role($role)</code>    #调用全局<code>WP_Roles</code>实例的<code>get_role($role)</code> 方法</li>
<li><code>add_role($role)</code>    #调用全局<code>WP_Roles</code>实例的<code>add_role($role)</code> 方法</li>
<li><code>remove_role($role)</code>    #调用全局<code>WP_Roles</code>实例的<code>remove_role($role)</code> 方法</li>
<li><code>get_super_admins()</code>                #获取超级管理员数组</li>
<li><code>is_super_admin($user_id=false)</code>    #是否是超级管理员</li>
</ul>
<p>其中，<code>WP_Roles</code> 用于管理一组角色，<code>WP_Role</code>用于管理一个角色的各项能力。</p>
<h2>用法：</h2>
<h3>检查用户的capability</h3>
<p>最实用的函数是：<code>current_user_can($capability)</code>，可以用来检查当前用户是否有做某件事的权限。</p>
<h3>新建角色</h3>
<p>当内置的角色不满足实际需求时，还可以自定义自己的角色：</p>
<ul>
<li><code>wp_roles()</code>         #获取全局的<code>WP_Roles</code>实例</li>
<li><code>get_role($role)</code>    #调用全局<code>WP_Roles</code>实例的<code>get_role($role)</code> 方法</li>
<li><code>add_role($role)</code>    #调用全局<code>WP_Roles</code>实例的<code>add_role($role)</code> 方法</li>
<li><code>remove_role($role)</code>    #调用全局<code>WP_Roles</code>实例的<code>remove_role($role)</code> 方法</li>
</ul>
<p>比如，要增加一个新的角色<code>photo_uploader</code>,默认的capability是<code>organize_gallery</code>:</p>
<pre><code class="language-PHP">add_role('photo_uploader','Photo Uploader','organize_gallery');
</code></pre>
<p>要删除这个角色：</p>
<pre><code class="language-PHP">remove_role('photo_uploader');
</code></pre>
<h3>特定角色的capabilities管理</h3>
<p>如果想给一个已经存在的特定角色添加capability，可以获取该角色<code>WP_Role</code>实例后再调用<code>add_cap()</code>方法:</p>
<pre><code class="language-PHP">$role=get_role('author');
$role-&gt;add_cap('organize_gallery');
</code></pre>
<h3>用户角色-能力管理</h3>
<p>获取用户对象：</p>
<pre><code class="language-PHP">
//利用id获取用户对象
$user=new WP_User($id);

// 利用用户名获取用户对象
$user=new WP_User(null,$user_name);

</code></pre>
<p>管理用户的角色:</p>
<pre><code class="language-PHP">
//添加角色
$user-&gt;add_role($role);

//移除角色
$user-&gt;remove_role($role_name);

//设置角色(覆盖)
$user-&gt;set_role($role_name);

</code></pre>
<h2>WP_Roles类</h2>
<p><code>WP_Roles</code>是用来管理角色集合的，内部维护了具有之前提到的那种结构的<code>$roles</code>属性(PHP数组)，提供对一组角色进行管理的功能，当调用：</p>
<p><code>add_role($role,$display_name,$capabilities=array())</code></p>
<p>时，会优先检查该数组结构是否存在相应的$role是否已经存在，如果没有，再同步到数据库中，然后同步其他属性。</p>
<h2>WP_Role类</h2>
<p><code>WP_Role</code>类是非常简单的类，用于管理具体的角色都能做那些事。具有这样两个属性：</p>
<ul>
<li>name             # 此角色名</li>
<li>capabilities     # 此角色的能力集合</li>
</ul>
<p>然后针对capabilities这个集合提供这样几个方法：</p>
<ul>
<li><code>has_cap( $cap )</code></li>
<li><code>add_cap( $cap, $grant=true )</code></li>
<li><code>remove_cap( $cap )</code></li>
</ul>
<p><code>WP_Roles</code>中为指定角色添加$capabilities<code>add_cap()</code>方法：</p>
<pre><code>public function add_cap( $role, $cap, $grant = true ) {

    if ( ! isset( $this-&gt;roles[$role] ) )
        return;

    $this-&gt;roles[$role]['capabilities'][$cap] = $grant;
    if ( $this-&gt;use_db )
        update_option( $this-&gt;role_key, $this-&gt;roles );
}
</code></pre>
<p>本质上还是在操作$roles这个内部数组，然后同步到数据库中。</p>
<h2>WP_User类</h2>
<p><code>WP_User</code>类用于管理一个用户的角色和能力。</p>

              </div>
            </div>
          </div>
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/architecture/architecture1-basic-workflow.html">
                    WordPress 前台基础架构分析之一:基本流程
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <h2>基本流程代码分析</h2>
<p>WordPress并没有统一的入口，比如</p>
<ul>
<li><code>wp-login.php</code>    #用于登录</li>
<li><code>wp-admin/index.php</code>    #用于后台管理</li>
<li><code>index.php</code>    #前台博客功能入口</li>
</ul>
<p>这里要分析的是WordPress的前台功能基础架构。</p>
<h2>前台入口的基本逻辑</h2>
<p>前台入口文件<code>index.php</code>非常简单，所做的只是转而去加载WordPress博客头<code>wp-blog-header.php</code>文件。</p>
<pre><code class="language-PHP">//index.php

/** Loads the WordPress Environment and Template */
require( dirname( __FILE__ ) . '/wp-blog-header.php' );
</code></pre>
<p>而这<code>wp-blog-header.php</code>文件所做的事儿则是WordPress博客功能的核心：</p>
<pre><code class="language-PHP">
if ( !isset($wp_did_header) ) {
	$wp_did_header = true;


	#加载所有的必需文件
	require_once( dirname(__FILE__) . '/wp-load.php' );


	#执行WordPress的查询过程，设置相应全局变量
	wp();


	#利用模板加载器加载相应的模板
	require_once( ABSPATH . WPINC . '/template-loader.php' );
}
</code></pre>
<p>综上所述，WordPress博客功能便是做这三件事:</p>
<ol>
<li>加载必要的基础文件</li>
<li>执行查询并设置一些列全局变量，</li>
<li>加载特定的模板模板输出响应。</li>
</ol>

              </div>
            </div>
          </div>
          <div class="card article">
            <div class="card-content">
              <div class="media-content has-text-centered">
                <p class="title article-title">
                  <a href="posts/WindWhisper/PHP/WordPress/architecture/architecture2-query.html">
                    WordPress 前台基础架构分析之二：查询篇
                  </a>
                </p>
                <nav class="breadcrumb">
                  <ul>
                    <li>
                      <a href="">
                        风语
                      </a>
                    </li>
                    <li>
                      <a href="">
                        PHP
                      </a>
                    </li>
                    <li>
                      <a href="">
                        WordPress
                      </a>
                    </li>
                  </ul>
                </nav>
                <p class="post-tags">
                  <a href="/tags.html#WordPress">
                    <span class="tag is-info">
                      WordPress
                    </span>
                  </a>
                </p>
                <p class="subtitle is-6 article-subtitle">
                  <a href="#">
                    
                  </a>
                  on 2015-04-10
                </p>
              </div>
              <div class="content article-body">
                <h2>WordPress查询过程</h2>
<p>WordPress查询过程也即<code>wp()</code>函数的调用过程, 该函数定义于<code>wp-includes/functions.php</code>文件中:</p>
<pre><code class="language-PHP">//wp-includes/functions.php

function wp( $query_vars = '' ) {
	global $wp, $wp_query, $wp_the_query;
	$wp-&gt;main( $query_vars );

	if ( !isset($wp_the_query) )
		$wp_the_query = $wp_query;
}
</code></pre>
<p>这里涉及到三个全局类对象，<code>$wp</code>,<code>$wp_query</code>,<code>$wp_the_query</code>，均定义于<code>wp-settings.php</code>中，其中:</p>
<ol>
<li><code>$wp</code>则是的<code>WP</code>类(文件<code>wp-includes/class-wp.php</code>)的实例,表示当前请求的WordPress博客环境信息</li>
<li><code>$wp_the_query</code>和<code>wp_query</code>为<code>WP_Query</code>类(文件<code>wp-includes/class-wp.php</code>)实例，用于查询(其实是后者是对前者的引用)</li>
</ol>
<h3><code>WP</code>类</h3>
<p><code>$wp</code>有如下关键的属性和方法</p>
<ul>
<li>属性
<ul>
<li><code>$query_vars</code>和<code>$query_string</code>: 如m,p,posts,w,cat,s,exact,page,more,orderby,tag等等</li>
<li><code>$request</code> : Permalink或者request URI</li>
<li><code>$matched_rule</code> 和<code>$matched_query</code> : 重写匹配到的请求</li>
</ul>
</li>
<li>方法
<ul>
<li><code>main($query_vars='')</code>: 设置所有的变量到该环境类对象,该方法实际上只是调用这些方法
<ul>
<li><code>init();</code>                       #初始化</li>
<li><code>parse_request($query_args);</code>   #解析请求</li>
<li><code>send_headers();</code>               #发送响应头</li>
<li><code>query_posts();</code>                #执行查询</li>
<li><code>handle_404();</code>                 #处理404</li>
<li><code>register_globals();</code>           #注册全局变量</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>最值得关注的是这个<code>$wp-&gt;query_posts()</code>方法,其实调用的是在文件<code>settings.php</code>中定义的全局对象<code>$wp_the_query</code>进行调用</p>
<pre><code class="language-PHP">public function query_posts() {
    global $wp_the_query;
    $this-&gt;build_query_string();
    $wp_the_query-&gt;query($this-&gt;query_vars);    #调用WP_Query类对象的查询方法
}
</code></pre>
<h3>WP_Query</h3>
<h4>WP_Query的作用</h4>
<p>除了直接使用$wpdb调用相关的模型层方法，WordPress针对自身的数据库schema和常用功能设计了<code>WP_Query</code>类,该类位于WPINC/query.php文件中。</p>
<p>该类的构造器接受一个<code>query_string</code>的查询字符串或者对应的数组作为参数,返回一个<code>WP_Query</code>类对象,如：</p>
<pre><code class="language-PHP">$posts=new WP_Query(array(
    'showposts'=&gt;10,
    'offset'=&gt;0,
    'category'=&gt;0,
    'orderby'=&gt;'post_date',
    'order'=&gt;'desc',
    'include'=&gt;'',
    'exclude'=&gt;'',
    'meta_key'=&gt;'',
    'meta_value'=&gt;'',
    'post_type'=&gt;'post',
    'suppress_filters'=&gt;true,
    'post_status'=&gt;'publish'
));
</code></pre>
<p>当这个<code>$wp_query</code>对象执行查询后,一系列相应的属性会被重新设置。根据这些属性值，Loop过程会加载不同的模板。</p>
<p>比如，如果<code>$wp_query-&gt;is_search()</code>属性值被设置为真，WordPress会使用<code>search.php</code>模板(如果有的话)。</p>
<h3>WP_Query的属性和方法</h3>
<p>该类提供了一系列初始的属性和方法：</p>
<ul>
<li>属性
<ul>
<li><code>$query</code>    #保存了<code>wp_parse_args($queryString)</code>的返回值;</li>
<li><code>$query_vars</code>    #<code>$query</code>的关联数组</li>
<li><code>$queried_object</code>    #保存了请求的category,author,post 或page的信息</li>
<li><code>$queried_object_id</code></li>
<li><code>posts</code>           #<code>get_posts()</code>返回值，表示请求的posts</li>
<li><code>post_count</code>      #<code>get_posts()</code>返回的<code>posts</code>的数量</li>
<li><code>current_post</code>    #用于迭代，将要被显示的post的index</li>
<li><code>post</code>            #用于迭代，当前被显示的post</li>
<li><code>is_xxx</code>   #query flags 属性</li>
</ul>
</li>
<li>方法
<ul>
<li><code>init()</code>   #初始化并设置默认值</li>
<li><code>parse_query()</code> #解析query string或者相应数组,并设置query type booleans</li>
<li><code>parse_query_vars()</code>    #这个函数只是重新调用<code>parse_query()</code></li>
<li><code>get_posts()</code>   #从数据库中获取请求的posts，并生成<code>$posts</code>和<code>$post_count</code></li>
<li><code>query()</code>       #调用<code>parse_query()</code>和<code>get_posts()</code></li>
<li><code>rewind_posts()</code> #rewind</li>
<li><code>have_posts()</code>   #是否有posts</li>
<li><code>next_post()</code>    #在<code>$posts</code>中迭代倒下一个位置，递增<code>$current_post</code>，设置<code>$post</code></li>
<li><code>the_post()</code>     #迭代到下一个位置，并且设置全局$global变量</li>
<li><code>get_queried_object()</code></li>
<li><code>get_queried_object_id()</code></li>
<li><code>get()</code></li>
<li><code>set()</code></li>
<li><code>is_xxx()</code></li>
</ul>
</li>
</ul>
<p>值得注意的是，<code>query()</code>方法是这里的核心方法，它负责两大业务:</p>
<ol>
<li>是解析查询参数(并设置相应的属性值)</li>
<li>是根据解析参数值进行数据库查询(并设置相应属性)</li>
</ol>
<p>实际上只是调用:</p>
<ol>
<li><code>parse_query()</code></li>
<li><code>get_posts()</code></li>
</ol>
<p>当执行完查询之后，常用的可用属性包括：</p>
<ul>
<li><code>order</code></li>
<li><code>orderby</code>    #<code>author</code>|<code>date</code>|<code>title</code>|<code>modified</code>|<code>menu_order</code>|<code>parent</code>|<code>ID</code>|<code>rand</code>|<code>meta_value</code>| <code>none</code></li>
<li><code>cat</code>,<code>tag</code></li>
<li><code>category_name</code></li>
<li><code>categroy__and</code>,<code>tag__and</code>    #数组</li>
<li><code>category__in</code>,<code>tag__in</code>    #数组</li>
<li><code>category__not_in</code></li>
<li><code>tag_slug__and</code></li>
<li><code>tag_slug__in</code></li>
<li><code>showposts</code></li>
<li><code>p</code></li>
<li><code>name</code></li>
<li><code>page_id</code></li>
<li><code>pagename</code></li>
<li><code>post__in</code></li>
<li><code>post__not_in</code></li>
<li><code>post__type</code></li>
<li><code>post_status</code></li>
<li><code>author</code></li>
<li><code>author_name</code></li>
<li><code>hour</code></li>
<li><code>minute</code></li>
<li><code>second</code></li>
<li><code>day</code></li>
<li><code>monthnum</code></li>
<li><code>year</code></li>
<li><code>w</code></li>
<li><code>paged</code></li>
<li><code>offset</code></li>
<li><code>meta_key</code></li>
<li><code>meta_compare</code></li>
</ul>

              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div class="container">
      <div class="container has-text-centered">
        <a href="posts/page28.html">
          Previous
        </a>
        30 of 32
        <a href="posts/page30.html">
          Next
        </a>
      </div>
    </div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.js"></script>
    <script>
       // 处理形如 <code>$E=mc^2$</code> 形式的公式
 var inlineMathNodes=document.querySelectorAll('code');
 var re=/^\$(.*)\$$/;
 for(var j=0;j<inlineMathNodes.length;j++){
   var result=re.exec(inlineMathNodes.item(j).innerText);
   if(result!==null){
	 katex.render(result[1], inlineMathNodes.item(j));
   }
 }
 function removeNode(node){
   if(node.remove){
	 node.remove();
   }else{
	 return first.parentNode.removeChild(node);
   }
 };

 // 查找所有 pre code.language-math 节点 以备筛出数据公式
 var nodes=document.querySelectorAll("pre code.language-math");
 for(var i=0;i<nodes.length;i++){
   var node=nodes.item(i);
   // 魔术标记所在行 
   try{
	 var lines = node.innerText.split('\n');
	 if((!!lines) && lines.length > 0)
	 {
	   var first = lines[0];
	   if(first.trim().match(/%%(\s?)*KaTeX(\s?)*/i)){
		 var views = "";
		 // 逐行渲染
		 for(var k=1; k <lines.length; k++){
			 var f=lines[k];
			 views += katex.renderToString(f);
		 }
		 // 消除父级嵌套 
		 try{
		   node.innerHTML=views;
		 }catch(e){
		   // IE9 don't support the method of assignning value to tr.innerHTML. Maybe the code below will be removed in the future
		   console.log('IE9 sucks',e);
		   $(tr).html(node.innerHTML);
		 }
	   }
	 }
   }
   catch(err){
	 console.log(err)
   }
 }
    </script>
    <script>
      hljs.highlightAll();
    </script>
  </body>
</html>