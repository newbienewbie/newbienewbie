---
layout: post
title: 厂网优化小记
date: 2017-01-18 20:33:50
tags:
- Node.js
- ASP.NET
- Nginx
categories:
- Misc
---

最近在集中办公搞分公司的`EPBP`项目，博客日志都疏忽了。

趁着今日午休的时候，对厂网再次优化了下，目前响应等待时间已经降到 68ms 左右了。想起刚刚接手的时候打开首页至少要 2.3秒，还是非常欣慰的，毕竟现在算是达到一个网站该有的速度水平了。

## 小结

总体说来，原网站系统过慢的原因：
1. 基于`ASP.NET`的`Web Form`技术，大量使用服务端组件
2. 大量冗余无效代码
3. 低效`SQL`查询
4. 数据库索引做的渣

针对上面的代码，改造措施如下：
* 对于第1点，大量使用`React.js`进行改造。
* 对应第2点，比如为了拼接字符串，对数据进行两次或者多次迭代、甚至嵌套循环的情况，尽量减少循环次数，把时间复杂度从O(n^2)降为O(n)。
* 对用第3点，比如原代码中存在这样的情况：先通过`C#`调用数据库访问层查出指定栏目的id、再使用`C#`拼接`SQL`字符串去查相应栏目下的最新几篇文章。直接把两次查询优化成一句`SQL`，只查一次就拿到结果。
* 对于第4点，没啥好说的，做好索引，比如对文章表的`栏目id`、`创建日期`列做索引。
* 除了以上几点，还使用了`Node.js`对一些网页进行了改造，比如目前首页分成两部分，一部分仍然使用`ASP.NET`技术，另一部分比如登陆状态、Banner、欢迎信息、访问量统计都使用`Node.js`进行改写，二者通过`Nginx`配合为前端提供服务。

在维护的这段时间，除了优化之外，搞过的重要的事儿还包括这些：

* 在保留老账号系统的基础上，添加使用`AD`域认证机制。
* 重写原有的数据库访问层——因为`SQL`注入这些漏洞随处可见
* 重写管理后台，动机主要是各种上传漏洞满天飞。改后附带效果响应速度提升7.3倍左右。
* 新增国际油价抓取、展示模块，模拟登陆东方油气网后台，抓取近日油价，存入后端数据库后展示到首页。
* 新增荣誉积分模块，后台拖曳`Excel`完成当期数据导入，前端根据累计积分排名展示，并提供历史查询和相应资料下载。
* 其他，如版面调整、`bug`修复、`XSS`等安全漏洞修复等

## 后话

自从被忽悠去接手这个项目，已经过去九个月了。然而接手的第二个月，大`BOSS`就调走了，一方面奖励再无兑现的可能，另一方面，领导也不关心网站的速度——毕竟点开首页需要2.3秒这事儿已经存在很多年了。单位并不是一个互联网企业，对这类东西并不看重，领导只看能不能打开网站而已。所以随着前`BOSS`调任其他单位，这些事儿注定都不会有回报，也不会有任何人关心。但是我还是要坚持做完这件事，因为既然答应接手了这个遗留项目，致力于修复`Bug`、优化代码，是一个技术人该有的追求。

也正是因为这样，当今天中午看到响应等待时间降到68毫秒时，我内心几乎是狂喜的，我兴奋地从座位上站了起来，我几乎要大声呼喊出来，然后我望到了不远处正午休的同事，又咽回了内心的激动。我掏出手机给我对象发消息，码了一会儿，想到她对这些并不感兴趣，于是又都删了。然后我坐下来，喝了口早已凉掉的水，默默用渣渣的英文发了条状态。

我脑子里想到了庖丁解牛的那些话：

> 虽然，每至于族，吾见其难为，怵然为戒，视为止、行为迟，动刀甚微，謋然已解，如土委地。提刀而立，为之四顾，为之踌躇满志，善刀而藏之。 

嗯，现在算是给了自己一个交代，可以善刀而藏了。
