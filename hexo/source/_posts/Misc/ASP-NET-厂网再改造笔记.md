---
layout: post
title: ASP.NET 厂网再改造笔记
date: 2017-03-11 22:16:59
tags:
- Node.js
- ASP.NET
- Nginx
categories:
- Misc
---
领导上周末打电话安排要对单位网站首页的产量公告按照配产要求进行改造，说实话，我还以为上次的优化是 final commit 了。不过既然领导安排了任务，不管有没有回报，都必须去执行。

这次改造过程不得不说是“一波三折”。领导安排任务正是我天天在局办公大厦加班搞分公司`EPBP`可研PPT的时候，好不容易周三晚上得空了，才开始分析同事传来的需求图。发现要动数据库，后台完全重写，首页按照领导的布局，可能放不下。不管咋说，后台还是好做的。后台数据库是 SQL Server 2005，考虑到是单兵作战，首选`Node.js`来开发，通过`Nginx`完成与`ASP.NET`配合。

开工，基本步骤:
0. 设计数据库，新建一张产量目标表、产量记录表，完成原始数据迁移。
1. 利用`SequelizeJS`完成数据库访问。
2. 编写相关服务及单元测试
3. 编写后台路由及管理界面的前端部分；后台管理界面直接上`Ant Design`
5. 编写首页的前端部分。

## 小坑

遇到些小坑问题：

1. 时间问题：老系统的时间实际是把本地日期直接当`UTC`日期存储(相差了8小时)。在给服务端传递日期的时候需要注意传递本地时间，后端拿到后读取传递日期的年、月、日，再强制设置为`UTC`时间。
2. 首页布局问题：同事传来的产量公告的布局不合理——首页压根放不下，经过两天反复协商，最终改为表格式。由于我平时还得忙着汇报材料，南北疆远程沟通，效率极低。
3. 样式问题：之前代码改造主要集中在后端和`JavaScript`方面。遗留的老`CSS`脏代码太多，实在没有勇气重构。由于这次要涉及大量样式调整，终于鼓起勇气用`less`重写了整个首页`CSS`代码。对于首页的服务端渲染的部分，比如通知公告、新闻动态、会议纪要、生产信息等样式采用静态css的样式，方便`Chrome`浏览器提前渲染；对于客户端渲染部分的样式，则使用`Webpack`打包动态创建`style`标签，当用户把页面下拉到下一屏时，浏览器已经完成这部分的渲染。

## 巨坑

服务器跑的是 `Windows Server 2008 R2`，搭载的数据库是`SQL Server 2005`；而我本机用的是`SQL Server 2014`进行开发、单元测试的。我当时并没有意识到这是个恐怖的大问题，`SequelizeJS`在做分表查询的时候使用了`offset ... fetch next ...`，而这一特性是从`SQL Server 2012`才引入的。等我以为一切开发测试完毕，趁着大家午休时间部署到生产服务器上后，我才发现有些不对劲，后端 `REST API` 一直报错。一查 `pm2 log`，才意识到我的重大失误。然后开始立刻紧急回滚代码。

代码回滚、重新部署完毕，第一思路是升级数据库，但是手头唯一可用的空闲服务器因为硬盘报废了三块，已于一个多月之前挂了。而且由于一些的奇特的原因，短期内是没有恢复的希望了。原地升级数据库，除了风险较大不说，更恐怖的事是目前的服务器操作系统是`Windows Server 2008 R2`，要安装`SQL Server 2012`，根据`Windows`官方文档，必须升级到`2008 R2 SP2`。在没有多余服务器的情况下，让我隔着几百公里远程升级操作系统和数据库，这个风险就太难控了。
花了一整天时间查阅资料并对风险进行评估后，我不得不选择了最不愿意选择的思路：再在服务器上安装一个`MySQL`数据库，然后把数据库访问层及相关服务的代码进行少量调整，比如字段类型、和PV计数的原始SQL语句。

## 最终

最终首页部分渲染为：

{% asset_img "chanliangonggao.png" "产量公告"  %}
