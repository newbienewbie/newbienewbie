---
layout: post
title: 腾讯云发送邮件的若干问题
date: 2018-12-29 21:45:20
tags:
- 随笔
- 邮件
- 腾讯云
categories:
- Misc
---


有个一个诡异的问题，连续好些天，都未能解决：网站需要发送邮件，然而本地服务器可以正常发送，一旦部署到远程服务器上就无法工作，就报错说发送失败，什么关键信息也没留下；而远程服务器上相应的出站端口都是开放的，我一度以为是我哪地方的环境配置出了问题，或者是什么边缘情况没考虑到。调试了很久，今天才得以解决，特此记录。

1. 头些年我用的是网易邮箱的`SMTP`功能，现在遇到这种情况，第一直觉以为是被其他邮件服务器当作垃圾邮件拦截了：以前使用`GMail`时被拦截过，不过那时网易邮箱可以正常发送。难道是是网易审核严了，不想提供这种吃力不讨好的免费服务了？
2. 于是我打算换用域名邮箱试试，搜了一圈，选定了QQ邮箱提供免费的域名邮箱。经过简单设置，本地代码工作正常，然而部署到远程服务器上又他娘跪了。报错信息是一如既往的纱布。
3. 搜了一下，网上说腾讯的QQ邮箱限制比较多，可能会过滤IP、会限制邮件次数，建议使用腾讯的企业邮箱。似乎有点道理，之前用`SendGrid`发邮件，确实是有些IP无法发送。难道是我选的国外服务器的IP地址被加入黑名单了？
4. 我又去申请了一个企业邮箱，重新设置域名`DNS`的`MX`记录。等解析正常后，简单修改了网站的本地配置，然而一运行便报错。后来网上检索才发现，` System.Net.Mail`不支持 implicit ssl ，而且这又是 by design 行为。我又按网上说法使用普通`25`端口，终于本地代码可以工作了。 然后部署到远程服务器，继续跪了。
5. 正当我反复比对、调试一筹莫展的时候，我突然想到，是不是我思路有问题？有没有可能问题不在我，而在于在远程服务器的提供商？于是我以腾讯云为关键词搜索，果然发现了猫腻。我一直都以为是我哪里配置不对的问题，完全没想到居然是腾讯云这个家伙在背后做了手脚：

<!-- more -->

> 为了提升腾讯云 IP 地址发邮件的质量，默认限制云服务器 TCP 25 端口连接外部地址，如果您没有在云上部署邮件服务，该限制不会影响您的服务；如果您需要使用邮件服务，我们诚挚地向您推荐腾讯企业邮箱。如果您一定要使用云主机向外连接 TCP 25 端口，请确保 TCP 25 端口仅用来连接第三方 SMTP 服务器，从第三方 SMTP 服务器外发邮件。如发现您使用云主机直接 SMTP 发送邮件，腾讯云有权永久封禁 TCP 25 端口，并不再提供相关服务。

真是无力吐槽了。这个默认封禁理由不管你信不信，反正我是无法信(服)的。

最终解决办法：前往[25端口解封界面](https://console.cloud.tencent.com/secctrl/smtp) , 申请解封即可。

PS: 云这东西，掏点小钱就能租，很方便。然而，说句不客气的话，只用公有云，等同于把自己的命根子交出去让别人攥着。
