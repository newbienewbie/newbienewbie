---
layout: post
title: 记 Swiper.js 复制DOM引发的Bug
date: 2018-4-27 23:52:34
tags:
- Swiper.js
- ECMAScript
categories:
- Misc
---

最近接手了有个小项目，大致是做个类似于易企秀之类的前端页面。核心功能是，对于指定模板：

1. 在编辑模式下，可以对文字、图片进行在线编辑，点击保存后提交相应数据到服务器
2. 在浏览模式下，向服务器请求数据，渲染生成个性页面

在我之前已经有个前端做好的各屏样式、动效。但是他写的在线可编辑功能是用纯手工的`input name=""`做的，这导致在线编辑基本是废的——因为每个模板都有很多不同的可编辑部分，不可能全靠手工完成；而且一到渲染环节就抓瞎。

## 解决方案

本想用`HTML5`的`content-editable`做，不过这货在移动端的监听内容改变比较操蛋；而且对于图片无能为力。

好在在编程中，没有什么纸老虎是不能用加一层抽象解决的；如果有，那就再加一层。为此，我写了一个叫做`ItminusEditor`的`JavaScript`库，提供三类常用的可编辑组件：`EditableInput`、`EditableTextarea`、`EditableImage`。在此基础上，实现了以下功能： <!--more--> 
1. 根据`HTML`标记，自动创建可编辑组件，当组件内容变化，会同步到`JavaScript`对象`itEditor`中。也就是说，在特定的DOM对象和`itEditor`之间建立联系。
2. `itEditor`对象提供了一系列方法，重点包括：
	* 注册可编辑组件方法：`registerEditableItem(item)`
	* 从组件中取值：`getValues()`
	* 为组件设置值：`setValues(obj)`
	* 禁用可编辑功能：`setUneditable()`
	* 启用可编辑功能：`setEditable()`
3. 每次用户点击保存后，会通过`itEditor.getValues()`获取所有可编辑组件对应的值
4. 当需要渲染时候，可以通过`itEditor.setValues()`完成所有可编辑组件的渲染工作

## Bug的发现与处理

在单独测试的时候，我写的`ItminusEditor`库并未发现什么问题。然后在项目中配合`Swiper.js`联合使用的时候，总是发现一些诡异的错误。比如，第一屏滚回最后一屏再滚回第一屏，会导致原本不可编辑状态的`EditableImage`变成了可编辑状态。

然后我开始了漫长的调试过程，我反复检查了我的代码，然后又在浏览器里反复调试，寻找Bug产生的原因。不知道过了多久，我突然意识到`DOM`里总是有冗余的一屏的`DOM`：原来只有5屏代码，为了实现循环，`Swiper.js`却在背后悄悄的复制产生了相同DOM，形成了事实上的6屏(视觉上是5屏)。

问题就出在这里，我的代码是根据相关`HTML`标记自动创建可编辑组件，然后在相关DOM与`JavaScript`对象`itEditor`之间建立了双向关联，而`Swiper.js`复制出的`DOM`并不会与`itEditor`有关联，所以才导致了这个Bug。

由于是我第一次使用`Swiper.js`，想去官网看下文档，结果百度满屏都是`Swiper.js`中文网的资料，我还以为是国人开发的开源库。于是以关键词`Swiper.js`、`复制DOM`、`事件`中文关键词搜索，结果并未发现什么有意义的答案。去论坛搜下也没发现有意义的答案。我看到中文网上写的"开源"，点击下载，却跳转到了百度云，这让我隐约觉得有点不靠谱，随即我对看这个网站上提供的文档失去了耐心——我很愚蠢的丧失了一次可能及早发现Bug的机会：事实上，在[文档](http://www.swiper.com.cn/api/loop/22.html)中指出了`loop`会复制`slide`。

尽管如此，此时再换掉`Swiper.js`代价过大，然后我开始尝试写兼容代码，
1. 比如为了`Swiper.js`组件悄悄创建的DOM也能受到不可编辑约束，我改了代码，让注册组件时不再检测是否已经有重复组件被注册
2. 但是采用第1步，带来了问题，多个重复的组件设置时会互相覆盖，带来数据不一致问题
3. 为了解决第2点中问题，又强制每次可编辑组件改变时同广播到所有组件，这样即使有同名组件，也会相互间保持一致。
4. 解决前三点问题，又发现`EditableImage`的点击事件代码经常无法触发，而且由于广播造成效率较低，偶尔还能看到抖动。

最后，我开始意识到问题并不简单，这样搞下去很可能会把问题的复杂程度大幅提高，延误工期。于是我重新以英文关键词`Swiper.js`、`loop`、`duplication`检索，试图找出`Swiper.js`不复制`DOM`的方法，终于发现了`github`上有个官方仓库，还有个哥们提了类似的[问题](https://github.com/nolimits4web/swiper/issues/2588)。顺带找到了真正的官方网站，按照文档描述，设置`loop:false`，终于不再有各种诡异的BUG了。

## 小结

1. 当试图捆绑DOM组件和JavaScript对象，在二者之间建立联系，如果第三方库悄悄在背后复制、修改、替换DOM，就要警惕会不会有Bug。
2. 务必认真阅读文档
3. 如果一个中文网站起名叫XX中文网，域名十分令人相信是官方网站（诸如xxx.com.cn），也集成了论坛、文档，且其上提供的库号称开源，却要去百度云下载源代码，记得第一时间去`GitHub`搜相关仓库，因为该网站极有可能是个中文推广网站。

