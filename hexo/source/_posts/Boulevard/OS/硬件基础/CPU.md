---
layout: post
title: 操作系统笔记 硬件基础——CPU
date: 2017-10-26 13:25:23
tags:
- 操作系统
- 硬件基础
- CPU结构
categories:
- 大道
- 操作系统
- 硬件基础
---

## CPU结构

CPU 主要有运算器、控制器、寄存器组、和内部总线组成。

```
                                                 执行指令控制
                                                  ^^^^^^^^^
                   +---+                          |-------|
                   |PSW<---+---------+        +---------------+
                   +---+   |         |        | 操 作 控 制 器 |      +-------+
                       +---+   ALU   |        |               <------+ 时 钟 |
      +------+         | +-+         |        | 时 序 产 生 器 <------+ 状 态 |
+-----+      +---+     | | +-+-+--^^-+        +-----+-+-+------      +-------+
| ----+ RAM  +---+     | |   ^ ^  | |               ^ ^ ^ ^
| |   +------+ | |     | |   | |  | |               | | | |
| |            | |    +v-v---+-+  | |             +--+-+-+-+---+
| |            | |    |  AC    <--- |             |    ID      |
| |            | |    +------^^+  | |             +---^-^------+
| |            | |           ||   | |               | |
| ----+-----+----+         +---------+             +-+-+------+
| ----+ I/O +----+         |   DR    +------------->   IR     |
| |   +-----+  | |         +---^-^---+             -+-+-------+
| |            | |  DBus       | |                  | |
| |            | +------------------------------------+
| |            +--------------------------------------+
| |                                                 | |    +------+
| |                                                 | +----+  PC  |
| |                                                 +-------------+
| |                                                 | |    +------+
| |                                                 | +----+  AR  |
| |                                                 +---------+-+-+
| |  ABus                                                     | |
| ------------------------------------------------------------+ |
+---------------------------------------------------------------+
```
<!-- more -->

### 运算器

* 算术逻辑单元（`Arithmetic and Logic Unit`, `ALU`）:负责对数据进行算术运算和逻辑运算。
* 累加寄存器（`AC`）：累加器，通用寄存器，为`ALU`提供了一个工作区。
* 数据缓冲寄存器（`DR`）:为CPU和内存、外围设备之间数据传送的中转站、缓冲。
* 状态条件寄存器（`PSW`）:包括状态标准和控制标志，例如进位(C)、溢出(V)、运算结果为0（Z）、运算结果为负值（N）、中断（I）等。

### 控制器

控制器用于控制整个CPU的工作。一般包括：

- 指令寄存器（`IR`）:当CPU执行一条指令时，先把它从内存中取到`DR`，然后送入`IR`暂存。指令译码器根据`IR`的内容产生各种微操作指令，控制其他部件完成工作。
- 程序计数器（`PC`）: 又称之为指令计数器，`PC`有寄存信息和计数两个功能。执行指令时，CPU将自动修改`PC`内容，使其保持的总是将要执行的下一条指令的地址。
- 地址寄存器（`AR`）: 保存了当前CPU所访问内容单元的地址，直到对内存的读写操作完成。
- 指令译码器（`ID`）: 指令分为操作码和地址码两部分。`ID`是对指令中的操作码字段进行分析解释，识别指令规定的操作，向操作控制器发出具体的控制信号，控制各部件完成工作。

其他还包括：
* 时序控制器：为每条指令按时间顺序提供有效的控制信号。
* 总线逻辑：信息通路的控制电路。
* 中断控制器：用于控制各种中断请求，并根据优先级进行排队，逐个交给CPU处理。
* e.t.c


### 寄存器组

分为通用寄存器和专用寄存器。专用寄存器作用是固定的，如控制器和运算器中的寄存器。而通用寄存器可以由程序员指定用途。

## 指令执行过程

1. 取指：从内存中读取一条指令到`DR`，然后送入`IR`
2. 解码: `ID`对指令进行分析解码，识别规定的动作
3. 执行 

### 流水线技术

CPU可以有分开的取值单元、解码单元、和执行单元。也就是说，不必等到一条指令从头到尾执行完毕后再开始处理下一条指令。三级流水线其示意图为：
```
// 流水线技术
          ^
          |                                           X : 取指流水线
          |                                           Y : 解码流水线
          |                                           Z : 执行流水线
          |
          |
+-------+ +------+------+-----------------+-----+
   X      |  1   |  2   |       ...       |  n  |
+-------+ +----------+------+-------------+----------+
   Y      |      | 1 |  | 2 |      ...          | n  |
+-------+ |      +------+---------+-----+-----+-+---------+
   Z      |          |  1   |  2  |  3  | ... |      | n  |   时间
+-------+ +-----------------+-----+-----+-----+------------------>
          |XXXXXX|YYY|                               |ZZZZ|
          |XXXXXX|YYY|                               |ZZZZ|
          +----------+                               +----+
```

在某个时刻，第一条指令取指完成（对应图中XXXXXX标注区域），解码流水线立即开始第一条指令的解码，同时取指流水线开始对第二条指令的取指；第一条指令的解码操作完成之后（对应图中YYYY标注区域），执行流水线开始对第一条指令的执行操作，同时解码流水线等待第二条指令送达。

假设每条指令的取指操作需要`$\Delta t_1 $`时间，解码需要`$\Delta t_2$`时间，执行需要消耗`$\Delta t_3$`时间，则最终执行N条指令，则完成上图N条指令共需要时间为：
```math
%% KaTex
(\sum\limits_{i=1}^3 \Delta t_i) + (n-1)*\Delta t_3
```
