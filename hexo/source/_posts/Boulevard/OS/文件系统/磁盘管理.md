---
layout: post
title: 操作系统笔记 文件系统—磁盘管理
date: 2017-10-28 17:14:20
tags:
- 操作系统
- 文件系统
- 磁盘管理
- 位图表示法
categories:
- 大道
- 操作系统
- 文件系统
---


## 空闲块管理

如何跟踪磁盘的空闲块？通常有三种方式：一种是采用磁盘块表法，一种是采用磁盘块链法，另一种可选办法是采用位示图表示法。

### 空闲表法

适合于文件的连续分配方式。操作系统为每个文件分配一个连续的存储空间，并为所有的存储空间建立一个空闲表，每个空闲区对应一个空闲表项，表项包括空闲区第一块号和空闲区空闲块数等信息。

### 空闲链法

在每个空闲块下设置了指向下一个空闲物理块的指针，所有的空闲块连接构成了一个空闲块链表。

### 位示图法

为了表示磁盘块的使用情况，位示图表示法对每个磁盘块用一个比特位记录其使用情况，n个块的磁盘需要采用n位位图。

例如：设有磁盘总容量为`$200GB=200*2^{30}Bytes$`，若每个磁盘块大小为`$1MB=1*2^{20}Bytes$`，则共需`$ 200 \times 2^{30} \div 2^{20}=200\times 2^{10} $`个比特位来记录磁盘使用情况。如果系统字长为32位，则位图大小为`$200\times 1024 \div 32=6400$`个字。其中，第一个字描述磁盘块号的范围是`$[0,31)$`，第二个字描述的磁盘块号的范范围是`$[32,64)$`，... ... ，第N个字描述的磁盘块范围是`$[32(N-1),32N)$`。<!--more--> 

## 多级索引结构

单级索引至少存在两个问题，一个是当把整个索引表都载入内存时会浪费内存空间，另一个问题是文件大小的尺寸受限。

例如有一个文件系统，设磁盘块大小为512Bytes，每个块号占用3Bytes，则每个磁盘块最多存放170个块号，故采用一级索引时，文件最多采用170个磁盘块存储，故文件大小的上限为`$170*512B/1024=85KB$`。如果采用二级索引，文件的最大长度为`$170*170*512B/1024=14450KB$`。

再如，有一个文件系统，设文件索引有7个地址项，分别是4个直接地址索引，2个一级间接地址索引，和1个二级间接地址索引。每个地址项占据4个字节，若磁盘索引块和数据块大小均为256Bytes，则单个文件的最大长度的计算过程为：
1. 4个直接地址索引可以引用的数据块数为4，故相应的容量`$F0$`为`$4*256$` Bytes。
2. 2个一级间接地址索引可以引用2个索引块，每个索引块中最多含有`$256/4$`个索引，每一项索引可以索引一个磁盘块，故相应的容量`$F1$`为 `$2*(256/4)*256 $`Bytes
3. 1个二级间接地址索引可以引用1个二级索引块，每个二级索引块可以引用`$256/4$`个一级索引块，这些一级索引块继续索引`$(256/4) \times (256/4)$`个磁盘块，故相应的容量`$F2$`为`$ (256/4) \times (256/4) \times 256 $`Bytes。
4. 最终，文件最大长度为：`$F0+F1+F2= 1057KB$`。

## Unix 系统实现

Unix系统的实现更为复杂，其中每个文件都有一个`inode`节点，每个`inode`都包含了：
* di-mod   : 文件属性
* di-nlike : 共享数
* di-uid   : 主用户标识
* di-gid   : 组用户标识
* di-size  : 文件大小
* di-add   : 存放文件所在物理块号的索引表
* di-atime : 文件最近访问时间
* di-mtime : 文件最近修改时间
* di-ctime ：文件最近创建时间

`inode`共有13个指针用于空间分配。
* 前10个指向可以直接访问的磁盘块，对于小文件而言，一个索引块就够了。
* 剩下的3个指针指向间接块(不包含文件数据)。
    * 第1个指针指向一级间接块。一级间接块也是索引块，包含了指向数据块的指针。
    * 第2个指针指向二级间接块。
    * 第3个指针指向三级间接块。
